<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dinner Roulette</title>
  <meta name="theme-color" content="#4a90e2" />
  <meta name="description" content="Collaboratively pick a restaurant with friends" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Dinner Roulette" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3/dist/cdn.min.js"></script>
  <script defer src="app.js?v=7"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
</head>
<body>
  <div x-data="dinnerRoulette()" x-init="init()">

    <!-- Toast -->
    <div class="toast" x-show="toast.visible" x-transition.opacity.duration.300ms
         :class="toast.type" x-text="toast.message"></div>

    <header>
      <div class="header-content">
        <img src="icon-192.png" alt="Dinner Roulette Logo" class="logo" />
        <h1>Dinner Roulette</h1>
        <div class="header-actions" x-show="loggedIn">
          <button class="theme-toggle" @click="toggleTheme()" :aria-label="theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'">
            <span x-text="theme === 'dark' ? '‚òÄÔ∏è' : 'üåô'"></span>
          </button>
          <span class="username-badge" x-text="username"></span>
          <button class="logout-btn" @click="logout()">Logout</button>
        </div>
      </div>
    </header>

    <main>
      <!-- Authentication -->
      <section x-show="!loggedIn">
        <button class="toggle-btn" @click="sections.auth = !sections.auth">
          <span x-text="sections.auth ? '‚ñº' : '‚ñ∂'"></span> Log in or Register
        </button>
        <div x-show="sections.auth" x-collapse>
          <label for="auth-username">Username</label>
          <input id="auth-username" x-model="authForm.username" placeholder="Username"
                 @keydown.enter="$refs.authPass.focus()" aria-label="Username" />
          <label for="auth-password">Password</label>
          <input id="auth-password" x-ref="authPass" x-model="authForm.password" type="password"
                 placeholder="Password" @keydown.enter="login()" aria-label="Password" />
          <div class="remember-wrapper">
            <label for="remember-me">
              <input type="checkbox" id="remember-me" x-model="authForm.remember" />
              Remember Me
            </label>
          </div>
          <div class="buttons">
            <button @click="register()">Register</button>
            <button @click="login()">Login</button>
          </div>
          <p class="auth-error" x-show="authError" x-text="authError"></p>
        </div>
      </section>

      <!-- Place Management -->
      <section x-show="loggedIn">
        <button class="toggle-btn" @click="sections.places = !sections.places">
          <span x-text="sections.places ? '‚ñº' : '‚ñ∂'"></span> Your Places
        </button>
        <div x-show="sections.places" x-collapse>
          <div class="autocomplete-container">
            <input id="place-search" placeholder="Search for a place..." autocomplete="off"
                   x-model="placeSearch" @input.debounce.300ms="searchPlaces()"
                   @keydown.escape="predictions = []" aria-label="Search for a restaurant"
                   role="combobox" aria-expanded="false" :aria-expanded="predictions.length > 0" />
            <ul class="autocomplete-list" x-show="predictions.length > 0" role="listbox">
              <template x-for="pred in predictions" :key="pred.place_id">
                <li @click="selectPlace(pred)" x-text="pred.description" role="option" tabindex="0"
                    @keydown.enter="selectPlace(pred)"></li>
              </template>
            </ul>
          </div>
          <div class="buttons" x-show="selectedPlace">
            <button @click="likePlace()" aria-label="Like this place">üëç Like</button>
            <button @click="dislikePlace()" aria-label="Dislike this place">üëé Dislike</button>
          </div>
          <p x-show="selectedPlace">
            <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(selectedPlace?.name || '')"
               target="_blank" rel="noopener">View on Google Maps</a>
          </p>

          <!-- Filter & Sort -->
          <div x-show="likes.length > 3 || dislikes.length > 3" class="filter-controls">
            <input placeholder="Filter places..." x-model="placeFilter" aria-label="Filter your places" />
            <select class="filter-select" x-model="placeTypeFilter" aria-label="Filter by type">
              <option value="">All Types</option>
              <template x-for="t in uniqueRestaurantTypes" :key="t">
                <option :value="t" x-text="t"></option>
              </template>
            </select>
            <select class="filter-select" x-model="placeSortBy" aria-label="Sort by">
              <option value="name">Sort: Name</option>
              <option value="type">Sort: Type</option>
              <option value="visited">Sort: Unvisited First</option>
            </select>
          </div>

          <!-- Quick Pick -->
          <div x-show="likes.length > 0" class="quick-pick-section">
            <button class="quick-pick-btn" @click="quickPick()" :disabled="quickPicking">
              üé≤ Quick Pick from Likes
            </button>
            <div x-show="quickPickResult" class="quick-pick-result">
              <span x-text="quickPickResult?.name"></span>
              <span class="type-badge" x-show="quickPickResult?.restaurant_type" x-text="quickPickResult?.restaurant_type"></span>
              <a :href="quickPickMapUrl" target="_blank" rel="noopener">View on Map</a>
            </div>
          </div>

          <h3>Liked</h3>
          <ul class="place-list">
            <template x-for="place in filteredLikes" :key="place.name">
              <li>
                <div class="place-info">
                  <span x-text="place.name"></span>
                  <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                  <span class="visited-badge" x-show="place.visited_at">Visited</span>
                </div>
                <span class="place-actions">
                  <a class="reviews-link" x-show="place.place_id" :href="googleReviewsUrl(place.name, place.place_id)"
                     target="_blank" rel="noopener" aria-label="View Google reviews">Reviews</a>
                  <button class="map-btn" @click="openMap(place.name)" aria-label="View on map">Map</button>
                  <button class="visited-btn" :class="{ 'visited-active': place.visited_at }"
                          @click="place.visited_at ? unmarkVisited(place) : markVisited(place)"
                          x-text="place.visited_at ? '‚úì Visited' : 'Visited?'"
                          :aria-label="place.visited_at ? 'Unmark as visited' : 'Mark as visited'"></button>
                  <button class="suggest-btn" @click="suggestPersonal(place)"
                          :disabled="currentSuggestions.has(place.name)"
                          :title="currentSuggestions.has(place.name) ? 'Already suggested' : 'Add to suggestions'"
                          aria-label="Suggest this place">Suggest</button>
                  <button class="remove-btn" @click="removePlace('likes', place.name)" aria-label="Remove from likes">Remove</button>
                </span>
              </li>
            </template>
          </ul>
          <p x-show="likes.length === 0" class="empty-msg">No liked places yet.</p>

          <h3>Disliked</h3>
          <ul class="place-list">
            <template x-for="place in filteredDislikes" :key="place.name">
              <li>
                <div class="place-info">
                  <span x-text="place.name"></span>
                  <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                </div>
                <span class="place-actions">
                  <a class="reviews-link" x-show="place.place_id" :href="googleReviewsUrl(place.name, place.place_id)"
                     target="_blank" rel="noopener" aria-label="View Google reviews">Reviews</a>
                  <button class="map-btn" @click="openMap(place.name)" aria-label="View on map">Map</button>
                  <button class="remove-btn" @click="removePlace('dislikes', place.name)" aria-label="Remove from dislikes">Remove</button>
                </span>
              </li>
            </template>
          </ul>
          <p x-show="dislikes.length === 0" class="empty-msg">No disliked places yet.</p>
        </div>
      </section>

      <!-- Plan Dinner -->
      <section x-show="loggedIn">
        <button class="toggle-btn" @click="sections.plan = !sections.plan">
          <span x-text="sections.plan ? '‚ñº' : '‚ñ∂'"></span> Plan Dinner
          <span class="badge" x-show="friendRequests.length > 0" x-text="friendRequests.length"></span>
        </button>
        <div x-show="sections.plan" x-collapse>

          <!-- Friends -->
          <div>
            <label for="friend-input">Add a friend</label>
            <div class="inline-input">
              <input id="friend-input" x-model="friendUsername" placeholder="Friend's username"
                     @keydown.enter="inviteFriend()" aria-label="Friend's username" />
              <button @click="inviteFriend()">Send Request</button>
            </div>
          </div>

          <!-- Pending Friend Requests -->
          <div x-show="friendRequests.length > 0" class="friends-list">
            <h4>Friend Requests</h4>
            <ul>
              <template x-for="r in friendRequests" :key="r.id">
                <li>
                  <span x-text="r.username"></span>
                  <span class="place-actions">
                    <button class="suggest-btn" @click="acceptFriend(r.id)">Accept</button>
                    <button class="remove-btn" @click="rejectFriend(r.id)">Reject</button>
                  </span>
                </li>
              </template>
            </ul>
          </div>

          <!-- Friends List -->
          <div x-show="friends.length > 0" class="friends-list">
            <h4>Friends</h4>
            <ul>
              <template x-for="f in friends" :key="f.id">
                <li>
                  <span x-text="f.username"></span>
                  <span class="place-actions">
                    <button class="map-btn" @click="viewFriendLikes(f.id, f.username)">View Likes</button>
                    <button class="map-btn" @click="loadCommonPlaces(f.username)">Common Places</button>
                    <button class="remove-btn" @click="removeFriend(f.id)" aria-label="Remove friend">Remove</button>
                  </span>
                </li>
              </template>
            </ul>
          </div>

          <!-- Friend's Likes View -->
          <div x-show="viewingFriendLikes" class="friends-list">
            <h4 x-text="(viewingFriendLikes?.username || '') + String.fromCharCode(39) + 's Liked Places'"></h4>
            <ul class="place-list">
              <template x-for="place in viewingFriendLikes?.likes || []" :key="place.name">
                <li>
                  <div class="place-info">
                    <span x-text="place.name"></span>
                    <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                  </div>
                  <span class="place-actions">
                    <button class="suggest-btn"
                            @click="addFriendPlace(place)"
                            :disabled="likes.some(l => l.name === place.name)"
                            x-text="likes.some(l => l.name === place.name) ? 'Already liked' : '+ Add to Likes'"></button>
                    <button class="map-btn" @click="openMap(place.name)">Map</button>
                  </span>
                </li>
              </template>
            </ul>
            <p x-show="viewingFriendLikes?.likes?.length === 0" class="empty-msg">This friend hasn't liked any places yet.</p>
            <button class="back-btn" @click="viewingFriendLikes = null">Back</button>
          </div>

          <!-- Common Places -->
          <div x-show="commonPlaces.length > 0">
            <h4 x-text="'Common Places with ' + commonFriend"></h4>
            <ul>
              <template x-for="place in commonPlaces" :key="place">
                <li>
                  <span x-text="place"></span>
                  <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(place)"
                     target="_blank" rel="noopener" class="map-link-small">[Map]</a>
                </li>
              </template>
            </ul>
          </div>

          <!-- Personal Suggestions -->
          <div class="suggestions-subsection">
            <h3>Your Suggestions</h3>
            <ul>
              <template x-for="s in suggestions" :key="s.name">
                <li>
                  <div class="place-info">
                    <span x-text="s.name"></span>
                    <span class="type-badge" x-show="s.restaurant_type" x-text="s.restaurant_type"></span>
                  </div>
                  <span class="place-actions">
                    <a class="reviews-link" x-show="s.place_id" :href="googleReviewsUrl(s.name, s.place_id)"
                       target="_blank" rel="noopener" aria-label="View Google reviews">Reviews</a>
                    <button class="remove-btn" @click="removeSuggestion(s.name)" aria-label="Remove suggestion">Remove</button>
                  </span>
                </li>
              </template>
            </ul>
            <p x-show="suggestions.length === 0" class="empty-msg">No suggestions yet.</p>
          </div>

          <!-- Session Management -->
          <div class="session-subsection">
            <h3>Dinner Sessions</h3>
            <div x-show="!activeSession">
              <div class="inline-input">
                <input x-model="newSessionName" placeholder="Session name (e.g., Friday Dinner)"
                       @keydown.enter="createSession()" aria-label="Session name" />
                <button @click="createSession()">Create Session</button>
              </div>
              <div class="inline-input" style="margin-top: 0.5rem;">
                <input x-model="joinCode" placeholder="Enter invite code" maxlength="6"
                       style="text-transform: uppercase;" @keydown.enter="joinSession()" aria-label="Session invite code" />
                <button @click="joinSession()">Join Session</button>
              </div>

              <!-- Active Sessions -->
              <h4 x-show="activeSessions.length > 0">Active Sessions</h4>
              <ul class="session-list">
                <template x-for="s in activeSessions" :key="s.id">
                  <li @click="openSession(s.id)">
                    <div>
                      <strong x-text="s.name"></strong>
                      <span class="session-code" x-text="s.code"></span>
                      <span class="session-creator" x-text="'by ' + s.creator_username"></span>
                    </div>
                    <div>
                      <span class="session-status open">open</span>
                    </div>
                  </li>
                </template>
              </ul>

              <!-- Session History -->
              <h4 x-show="historySessions.length > 0">Session History</h4>
              <ul class="session-list">
                <template x-for="s in historySessions" :key="s.id">
                  <li @click="openSession(s.id)">
                    <div>
                      <strong x-text="s.name"></strong>
                      <span class="session-creator" x-text="'by ' + s.creator_username"></span>
                      <span class="session-date" x-text="formatDate(s.picked_at || s.created_at)"></span>
                    </div>
                    <div>
                      <span x-show="s.winner_place" class="session-winner" x-text="'Winner: ' + s.winner_place"></span>
                      <button class="remove-btn" x-show="s.creator_id === userId"
                              @click.stop="deleteSession(s.id)" aria-label="Delete session">Delete</button>
                    </div>
                  </li>
                </template>
              </ul>
              <p x-show="sessions.length === 0" class="empty-msg">No sessions yet. Create one or join with a code.</p>
            </div>

            <!-- Active Session View -->
            <div x-show="activeSession">
              <div class="session-header">
                <h4 x-text="activeSession?.session?.name"></h4>
                <span class="session-code clickable" @click="copyCode()" x-text="activeSession?.session?.code"
                      title="Click to copy"></span>
                <button class="back-btn" @click="closeActiveSession()">Back</button>
                <button class="remove-btn" x-show="activeSession?.session?.creator_id === userId && activeSession?.session?.status === 'open' && !closingSession"
                        @click="closeSession()">Close Session</button>
                <button class="back-btn" x-show="closingSession" @click="cancelClose()">Cancel</button>
                <button class="remove-btn" x-show="activeSession?.session?.creator_id === userId && activeSession?.session?.status === 'closed'"
                        @click="deleteSession(activeSession.session.id)">Delete Session</button>
              </div>
              <p class="members-line">
                <strong>Members:</strong> <span x-text="activeSession?.members?.map(m => m.username).join(', ')"></span>
              </p>
              <p x-show="activeSession?.session?.status === 'closed'" class="closed-badge">This session is closed.</p>

              <!-- Winner Selection on Close -->
              <div x-show="closingSession" class="close-winner-panel">
                <h4>Select the winning restaurant:</h4>
                <ul class="close-winner-list">
                  <template x-for="s in activeSession?.suggestions || []" :key="s.id">
                    <li @click="closeWithWinner(s.place)">
                      <span class="suggestion-name" x-text="s.place"></span>
                      <span class="type-badge" x-show="s.restaurant_type" x-text="s.restaurant_type"></span>
                      <span class="vote-count" x-text="s.vote_count + ' vote' + (s.vote_count !== 1 ? 's' : '')"></span>
                    </li>
                  </template>
                </ul>
                <button class="back-btn" @click="closeWithoutWinner()" style="margin-top: 0.5rem;">Close without winner</button>
              </div>

              <!-- Suggest to Session -->
              <div x-show="activeSession?.session?.status === 'open'">
                <h4>Suggest a Place</h4>
                <div class="autocomplete-container">
                  <input placeholder="Search for a restaurant..." autocomplete="off"
                         x-model="sessionPlaceSearch" @input.debounce.300ms="searchSessionPlaces()"
                         @keydown.escape="sessionPredictions = []" aria-label="Search to suggest a restaurant" />
                  <ul class="autocomplete-list" x-show="sessionPredictions.length > 0" role="listbox">
                    <template x-for="pred in sessionPredictions" :key="pred.place_id">
                      <li @click="suggestToSession(pred.description, pred.place_id, formatPlaceType(pred.types))" x-text="pred.description"
                          role="option" tabindex="0"></li>
                    </template>
                  </ul>
                </div>
                <div x-show="likes.length > 0" class="liked-suggest-grid">
                  <span class="grid-label">Quick suggest from likes:</span>
                  <template x-for="place in likes" :key="place.name">
                    <button class="suggest-btn" @click="suggestToSession(place.name, place.place_id, place.restaurant_type)"
                            x-text="'+ ' + place.name" :aria-label="'Suggest ' + place.name"></button>
                  </template>
                </div>
              </div>

              <!-- Session Suggestions with Votes -->
              <h4>Suggestions <span class="vote-hint" x-show="activeSession?.suggestions?.length > 0">(click Vote to upvote)</span></h4>
              <ul class="session-suggestion-list">
                <template x-for="s in activeSession?.suggestions || []" :key="s.id">
                  <li>
                    <div class="suggestion-info">
                      <span class="suggestion-name" x-text="s.place"></span>
                      <span class="type-badge" x-show="s.restaurant_type" x-text="s.restaurant_type"></span>
                      <span class="suggestion-by" x-text="'by ' + s.suggested_by"></span>
                    </div>
                    <div class="suggestion-actions">
                      <span class="vote-count" x-text="s.vote_count + ' vote' + (s.vote_count !== 1 ? 's' : '')"></span>
                      <button class="vote-btn" :class="{ voted: s.user_voted }"
                              @click="toggleVote(s)" x-text="s.user_voted ? 'Voted' : 'Vote'"
                              :aria-label="s.user_voted ? 'Remove vote' : 'Vote for ' + s.place"
                              x-show="activeSession?.session?.status === 'open'"></button>
                      <a class="reviews-link" x-show="s.place_id" :href="googleReviewsUrl(s.place, s.place_id)"
                         target="_blank" rel="noopener" aria-label="View Google reviews">Reviews</a>
                      <button class="map-btn" @click="openMap(s.place)" aria-label="View on map">Map</button>
                    </div>
                  </li>
                </template>
              </ul>
              <p x-show="!activeSession?.suggestions?.length" class="empty-msg">No suggestions yet. Add one above.</p>

              <!-- Pick Buttons -->
              <div class="buttons pick-buttons" x-show="activeSession?.suggestions?.length > 0">
                <button @click="randomPick()" :disabled="picking" aria-label="Random pick weighted by votes">üé≤ Random Pick</button>
                <button @click="closestPick()" :disabled="picking" aria-label="Pick the closest restaurant">üìç Closest</button>
              </div>

              <!-- Winner Display -->
              <div class="winner-display" x-show="winner" x-transition>
                <h3 x-text="winner?.place" id="winner-text"></h3>
                <p x-show="winner?.distance != null" x-text="winnerDistanceText"></p>
                <a :href="winnerMapUrl" target="_blank" rel="noopener"
                   x-text="winner?.distance != null ? 'Get Directions' : 'View on Google Maps'"></a>
              </div>
            </div>
          </div>

          <!-- Account Management -->
          <div class="account-subsection">
            <button class="toggle-btn" @click="sections.account = !sections.account">
              <span x-text="sections.account ? '‚ñº' : '‚ñ∂'"></span> Account Settings
            </button>
            <div x-show="sections.account" x-collapse>
              <h4>Change Password</h4>
              <input type="password" x-model="accountForm.currentPassword" placeholder="Current password" aria-label="Current password" />
              <input type="password" x-model="accountForm.newPassword" placeholder="New password (min 6 chars)" aria-label="New password" />
              <button @click="changePassword()">Change Password</button>

              <h4 class="danger-zone">Delete Account</h4>
              <p class="warning-text">This will permanently delete your account and all data.</p>
              <input type="password" x-model="accountForm.deletePassword" placeholder="Enter password to confirm" aria-label="Password to confirm deletion" />
              <button class="remove-btn" @click="deleteAccount()">Delete My Account</button>
            </div>
          </div>

        </div>
      </section>
    </main>
  </div>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js', { updateViaCache: 'none' });
    }
  </script>
</body>
</html>
