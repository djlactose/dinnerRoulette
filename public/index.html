<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dinner Roulette</title>
  <meta name="theme-color" content="#E07A5F" />
  <meta name="description" content="Collaboratively pick a restaurant with friends" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Dinner Roulette" />
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3/dist/cdn.min.js"></script>
  <script defer src="app.js?v=16"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
</head>
<body>
  <div x-data="dinnerRoulette()" x-init="init()">

    <!-- Toast -->
    <div class="toast" x-show="toast.visible" x-transition.opacity.duration.300ms
         :class="toast.type">
      <span x-text="toast.message"></span>
      <button class="toast-action" x-show="toast.action" x-text="toast.action?.label"
              @click="toast.action?.callback()"></button>
    </div>

    <!-- Offline Banner -->
    <div class="offline-banner" x-show="!online" x-transition.opacity>
      You are offline. Some features may be unavailable.
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-overlay" x-show="confirmModal.visible" x-transition.opacity.duration.200ms
         @click.self="confirmModal.onCancel()">
      <div class="confirm-modal" x-show="confirmModal.visible" x-transition.scale.origin.center>
        <p x-text="confirmModal.message"></p>
        <div class="confirm-modal-actions">
          <button class="back-btn" @click="confirmModal.onCancel()">Cancel</button>
          <button class="remove-btn" @click="confirmModal.onConfirm()">Confirm</button>
        </div>
      </div>
    </div>

    <header>
      <div class="header-content">
        <img src="icon-192.png" alt="Dinner Roulette Logo" class="logo" />
        <h1>Dinner Roulette</h1>
        <div class="header-actions" x-show="loggedIn">
          <button class="theme-toggle" @click="toggleTheme()" :aria-label="theme === 'auto' ? 'Switch to light mode' : theme === 'light' ? 'Switch to dark mode' : 'Switch to auto mode'">
            <span x-text="theme === 'auto' ? 'üíª' : theme === 'light' ? '‚òÄÔ∏è' : 'üåô'"></span>
          </button>
          <span class="avatar avatar-sm" :style="{ background: hashColor(username) }" x-text="getInitials(username)"></span>
          <span class="username-badge" x-text="username"></span>
          <button class="logout-btn" @click="logout()">Logout</button>
        </div>
      </div>
    </header>

    <main>
      <!-- Invite Banner (for logged-out users with pending invite) -->
      <div class="invite-banner" x-show="!loggedIn && pendingInviteCode">
        <p>You've been invited to a Dinner Roulette session!</p>
        <p class="invite-code-display" x-text="pendingInviteCode"></p>
        <p class="invite-hint">Log in or register below to join the session.</p>
      </div>

      <!-- Authentication -->
      <section x-show="!loggedIn">
        <!-- Password Reset Token Form -->
        <div x-show="resetMode && resetToken">
          <h3>Reset Password</h3>
          <div x-show="resetTokenValid">
            <p style="color: var(--text-secondary);">Resetting password for <strong x-text="resetUsername"></strong></p>
            <label>New Password</label>
            <input type="password" x-model="resetNewPassword" placeholder="New password (min 6 chars)"
                   @keydown.enter="$refs.resetConfirm.focus()" aria-label="New password" />
            <label>Confirm Password</label>
            <input type="password" x-ref="resetConfirm" x-model="resetConfirmPassword" placeholder="Confirm password"
                   @keydown.enter="submitPasswordReset()" aria-label="Confirm password" />
            <p class="auth-error" x-show="resetNewPassword && resetConfirmPassword && resetNewPassword !== resetConfirmPassword">
              Passwords do not match.
            </p>
            <div class="buttons">
              <button @click="submitPasswordReset()"
                      :disabled="!resetNewPassword || resetNewPassword !== resetConfirmPassword">Reset Password</button>
            </div>
          </div>
          <div x-show="!resetTokenValid">
            <p class="warning-text">This reset link is invalid or has expired.</p>
          </div>
          <p class="auth-error" x-show="authError" x-text="authError"></p>
          <p><a href="#" @click.prevent="resetMode = false; resetToken = ''; window.history.replaceState(null, '', '/')">Back to login</a></p>
        </div>

        <!-- Forgot Password Form -->
        <div x-show="resetMode && !resetToken">
          <h3>Forgot Password</h3>
          <p style="color: var(--text-secondary); font-size: 0.9rem;">Enter your email address and we'll send you a link to reset your password.</p>
          <label for="reset-email">Email</label>
          <input id="reset-email" x-model="resetEmail" type="email" placeholder="Your email address"
                 @keydown.enter="forgotPassword()" aria-label="Email for password reset" />
          <div class="buttons">
            <button @click="forgotPassword()">Send Reset Link</button>
            <button class="back-btn" @click="resetMode = false">Back</button>
          </div>
          <p class="auth-error" x-show="authError" x-text="authError"></p>
        </div>

        <!-- Normal Auth (Login/Register) -->
        <div x-show="!resetMode">
          <div class="auth-tabs">
            <button class="auth-tab" :class="{ active: authMode === 'login' }" @click="authMode = 'login'; authError = ''">Login</button>
            <button class="auth-tab" :class="{ active: authMode === 'register' }" @click="authMode = 'register'; authError = ''">Register</button>
          </div>

          <!-- Login Form -->
          <div x-show="authMode === 'login'">
            <label for="auth-username">Username</label>
            <input id="auth-username" x-model="authForm.username" placeholder="Username"
                   @keydown.enter="$refs.loginPass.focus()" aria-label="Username" />
            <label for="auth-password">Password</label>
            <input id="auth-password" x-ref="loginPass" x-model="authForm.password" type="password"
                   placeholder="Password" @keydown.enter="login()" aria-label="Password" />
            <div class="remember-wrapper">
              <label for="remember-me">
                <input type="checkbox" id="remember-me" x-model="authForm.remember" />
                Remember Me
              </label>
            </div>
            <div class="buttons">
              <button @click="login()">Login</button>
            </div>
            <p><a href="#" @click.prevent="resetMode = true; authError = ''">Forgot Password?</a></p>
          </div>

          <!-- Register Form -->
          <div x-show="authMode === 'register'">
            <label for="reg-username">Username</label>
            <input id="reg-username" x-model="authForm.username" placeholder="Username"
                   @keydown.enter="$refs.regEmail.focus()" aria-label="Username" />
            <label for="reg-email">Email</label>
            <input id="reg-email" x-ref="regEmail" x-model="authForm.email" type="email" placeholder="Email address"
                   @keydown.enter="$refs.regPass.focus()" aria-label="Email address" />
            <label for="reg-password">Password</label>
            <input id="reg-password" x-ref="regPass" x-model="authForm.password" type="password"
                   placeholder="Password (min 6 chars)" @keydown.enter="$refs.regConfirm.focus()" aria-label="Password" />
            <label for="reg-confirm">Confirm Password</label>
            <input id="reg-confirm" x-ref="regConfirm" x-model="authForm.confirmPassword" type="password"
                   placeholder="Confirm password" @keydown.enter="register()" aria-label="Confirm password" />
            <p class="auth-error" x-show="authForm.password && authForm.confirmPassword && authForm.password !== authForm.confirmPassword">
              Passwords do not match.
            </p>
            <div class="remember-wrapper">
              <label for="reg-remember">
                <input type="checkbox" id="reg-remember" x-model="authForm.remember" />
                Remember Me
              </label>
            </div>
            <div class="buttons">
              <button @click="register()"
                      :disabled="!authForm.username || !authForm.password || !authForm.email || authForm.password !== authForm.confirmPassword">Register</button>
            </div>
          </div>
          <p class="auth-error" x-show="authError" x-text="authError"></p>
        </div>
      </section>

      <!-- Tab Bar -->
      <nav class="tab-bar" x-show="loggedIn" role="tablist">
        <button class="tab-btn" :class="{ active: activeTab === 'places' }" @click="switchTab('places')" role="tab" aria-label="Places">
          <span class="tab-btn-icon">&#x1F37D;</span>
          <span class="tab-btn-label">Places</span>
        </button>
        <button class="tab-btn" :class="{ active: activeTab === 'friends' }" @click="switchTab('friends')" role="tab" aria-label="Friends">
          <span class="tab-btn-icon">&#x1F465;</span>
          <span class="tab-btn-label">Friends</span>
          <span class="tab-badge" x-show="friendRequests.length > 0" x-text="friendRequests.length"></span>
        </button>
        <button class="tab-btn" :class="{ active: activeTab === 'sessions' }" @click="switchTab('sessions')" role="tab" aria-label="Sessions">
          <span class="tab-btn-icon">&#x1F3B2;</span>
          <span class="tab-btn-label">Sessions</span>
          <span class="tab-badge" x-show="activeSessions.length > 0" x-text="activeSessions.length"></span>
        </button>
        <button class="tab-btn" :class="{ active: activeTab === 'account' }" @click="switchTab('account')" role="tab" aria-label="Account">
          <span class="tab-btn-icon">&#x2699;</span>
          <span class="tab-btn-label">Account</span>
        </button>
        <button class="tab-btn" :class="{ active: activeTab === 'admin' }" @click="switchTab('admin')" role="tab" aria-label="Admin"
                x-show="isAdmin">
          <span class="tab-btn-icon">&#x1F6E1;</span>
          <span class="tab-btn-label">Admin</span>
        </button>
      </nav>

      <!-- Floating Action Button -->
      <button class="fab" x-show="loggedIn && activeTab !== 'account' && activeTab !== 'admin'"
              @click="fabAction()" x-transition.scale.origin.bottom-right>
        <span x-text="activeTab === 'sessions' ? 'üé≤' : '+'"></span>
      </button>

      <!-- Tab Content -->
      <div x-show="loggedIn" class="tab-content">

        <!-- ‚ïê‚ïê‚ïê PLACES TAB ‚ïê‚ïê‚ïê -->
        <section x-show="activeTab === 'places'" x-transition:enter.opacity.duration.200ms>
          <div class="autocomplete-container">
            <input id="place-search" x-ref="placeSearch" placeholder="Search for a place..." autocomplete="off"
                   x-model="placeSearch" @input.debounce.300ms="searchPlaces()"
                   @keydown.escape="predictions = []; highlightedIndex = -1"
                   @keydown.arrow-down.prevent="handlePlaceKeydown($event)"
                   @keydown.arrow-up.prevent="handlePlaceKeydown($event)"
                   @keydown.enter.prevent="handlePlaceKeydown($event)"
                   aria-label="Search for a restaurant"
                   role="combobox" aria-expanded="false" :aria-expanded="predictions.length > 0"
                   :aria-activedescendant="highlightedIndex >= 0 ? 'place-opt-' + highlightedIndex : null" />
            <span class="spinner" x-show="searching"></span>
            <ul class="autocomplete-list" x-show="predictions.length > 0" role="listbox">
              <template x-for="(pred, index) in predictions" :key="pred.place_id">
                <li @click="selectPlace(pred)" x-text="pred.description" role="option" tabindex="0"
                    @keydown.enter="selectPlace(pred)"
                    :id="'place-opt-' + index"
                    :class="{ 'highlighted': index === highlightedIndex }"></li>
              </template>
            </ul>
            <p class="no-results" x-show="predictions.length === 0 && placeSearch.length > 2 && searchedOnce">
              No results found. Try a different search term.
            </p>
          </div>
          <div class="buttons" x-show="selectedPlace">
            <button @click="likePlace()" aria-label="Like this place">üëç Like</button>
            <button @click="dislikePlace()" aria-label="Dislike this place">üëé Dislike</button>
            <button class="want-to-try-btn" @click="wantToTryPlace()" aria-label="Add to want to try list">‚≠ê Want to Try</button>
          </div>
          <p x-show="selectedPlace">
            <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(selectedPlace?.name || '')"
               target="_blank" rel="noopener">View on Google Maps</a>
          </p>

          <!-- Filter & Sort -->
          <div x-show="likes.length > 3 || dislikes.length > 3 || wantToTry.length > 3" class="filter-controls">
            <input placeholder="Filter places..." x-model="placeFilter" aria-label="Filter your places" />
            <select class="filter-select" x-model="placeTypeFilter" aria-label="Filter by type">
              <option value="">All Types</option>
              <template x-for="t in uniqueRestaurantTypes" :key="t">
                <option :value="t" x-text="t"></option>
              </template>
            </select>
            <select class="filter-select" x-model="placeSortBy" aria-label="Sort by">
              <option value="name">Sort: Name</option>
              <option value="type">Sort: Type</option>
            </select>
          </div>

          <!-- Quick Pick -->
          <div x-show="likes.length > 0" class="quick-pick-section">
            <button class="quick-pick-btn" @click="quickPick()" :disabled="quickPicking">
              üé≤ Quick Pick from Likes
            </button>
            <div x-show="quickPickResult" class="quick-pick-result">
              <span x-text="quickPickResult?.name"></span>
              <span class="type-badge" x-show="quickPickResult?.restaurant_type" x-text="quickPickResult?.restaurant_type"></span>
              <a :href="quickPickMapUrl" target="_blank" rel="noopener">View on Map</a>
            </div>
          </div>

          <h3>Liked</h3>
          <!-- Skeleton Loading -->
          <div x-show="loading.places" class="skeleton-list">
            <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
            <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
            <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
          </div>
          <div class="place-card-grid" x-show="!loading.places">
            <template x-for="place in filteredLikes" :key="place.name">
              <div class="place-card"
                   @touchstart="onTouchStart($event, place.name)"
                   @touchmove="onTouchMove($event, place.name)"
                   @touchend="onTouchEnd('likes', place)"
                   :style="{ transform: getSwipeTransform(place.name), background: getSwipeBg(place.name) || undefined, transition: swipeState.swiping ? 'none' : 'transform 0.2s' }">
                <div class="place-card-header">
                  <strong x-text="place.name"></strong>
                  <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                </div>
                <div class="place-card-note" x-show="editingNote !== place.name && place.notes">
                  <span class="note-text" @click="startEditNote(place)" x-text="place.notes"></span>
                </div>
                <div class="place-note-edit" x-show="editingNote === place.name">
                  <input type="text" x-model="noteText" placeholder="Add a note..."
                         @keydown.enter="saveNote(place)" @keydown.escape="cancelEditNote()" />
                  <button class="suggest-btn" @click="saveNote(place)">Save</button>
                  <button class="back-btn" @click="cancelEditNote()">Cancel</button>
                </div>
                <div class="place-card-actions">
                  <a class="reviews-link" x-show="place.place_id" :href="googleReviewsUrl(place.name, place.place_id)"
                     target="_blank" rel="noopener" aria-label="View Google reviews">Reviews</a>
                  <button class="map-btn" @click="openMap(place.name)" aria-label="View on map">Map</button>
                  <button class="suggest-btn" @click="suggestPersonal(place)"
                          :disabled="currentSuggestions.has(place.name)"
                          :title="currentSuggestions.has(place.name) ? 'Already suggested' : 'Add to suggestions'"
                          aria-label="Suggest this place">Suggest</button>
                  <button class="note-add-btn" x-show="!place.notes && editingNote !== place.name"
                          @click="startEditNote(place)">+ Note</button>
                  <button class="remove-btn" @click="removePlace('likes', place.name)" aria-label="Remove from likes">Remove</button>
                </div>
              </div>
            </template>
          </div>
          <div x-show="likes.length === 0 && !loading.places" class="empty-state">
            <span class="empty-state-icon">&#x1F37D;</span>
            <p>No liked places yet.</p>
            <p class="empty-state-hint">Search above and tap Like to start building your list.</p>
          </div>

          <h3>Disliked</h3>
          <div x-show="loading.places" class="skeleton-list">
            <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
            <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
          </div>
          <div class="place-card-grid" x-show="!loading.places">
            <template x-for="place in filteredDislikes" :key="place.name">
              <div class="place-card"
                   @touchstart="onTouchStart($event, place.name)"
                   @touchmove="onTouchMove($event, place.name)"
                   @touchend="onTouchEnd('dislikes', place)"
                   :style="{ transform: getSwipeTransform(place.name), background: getSwipeBg(place.name) || undefined, transition: swipeState.swiping ? 'none' : 'transform 0.2s' }">
                <div class="place-card-header">
                  <strong x-text="place.name"></strong>
                  <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                </div>
                <div class="place-card-actions">
                  <a class="reviews-link" x-show="place.place_id" :href="googleReviewsUrl(place.name, place.place_id)"
                     target="_blank" rel="noopener" aria-label="View Google reviews">Reviews</a>
                  <button class="map-btn" @click="openMap(place.name)" aria-label="View on map">Map</button>
                  <button class="remove-btn" @click="removePlace('dislikes', place.name)" aria-label="Remove from dislikes">Remove</button>
                </div>
              </div>
            </template>
          </div>
          <div x-show="dislikes.length === 0 && !loading.places" class="empty-state">
            <span class="empty-state-icon">&#x1F44E;</span>
            <p>No disliked places yet.</p>
            <p class="empty-state-hint">Places you dislike will appear here.</p>
          </div>

          <h3>‚≠ê Want to Try</h3>
          <div x-show="loading.places" class="skeleton-list">
            <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
            <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
          </div>
          <div class="place-card-grid" x-show="!loading.places">
            <template x-for="place in filteredWantToTry" :key="place.name">
              <div class="place-card"
                   @touchstart="onTouchStart($event, place.name)"
                   @touchmove="onTouchMove($event, place.name)"
                   @touchend="onTouchEnd('want_to_try', place)"
                   :style="{ transform: getSwipeTransform(place.name), background: getSwipeBg(place.name) || undefined, transition: swipeState.swiping ? 'none' : 'transform 0.2s' }">
                <div class="place-card-header">
                  <strong x-text="place.name"></strong>
                  <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                </div>
                <div class="place-card-actions">
                  <a class="reviews-link" x-show="place.place_id" :href="googleReviewsUrl(place.name, place.place_id)"
                     target="_blank" rel="noopener" aria-label="View Google reviews">Reviews</a>
                  <button class="map-btn" @click="openMap(place.name)" aria-label="View on map">Map</button>
                  <button class="suggest-btn" x-show="activeSession && activeSession.session.status === 'open'"
                          @click="suggestToSession(place.name, place.place_id, place.restaurant_type)"
                          :disabled="currentSuggestions.has(place.name)"
                          :title="currentSuggestions.has(place.name) ? 'Already suggested' : 'Suggest to session'"
                          aria-label="Suggest this place">Suggest</button>
                  <button class="remove-btn" @click="removePlace('want_to_try', place.name)" aria-label="Remove from want to try">Remove</button>
                </div>
              </div>
            </template>
          </div>
          <div x-show="wantToTry.length === 0 && !loading.places" class="empty-state">
            <span class="empty-state-icon">‚≠ê</span>
            <p>No places on your bucket list yet.</p>
            <p class="empty-state-hint">Mark places you want to try!</p>
          </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê FRIENDS TAB ‚ïê‚ïê‚ïê -->
        <section x-show="activeTab === 'friends'" x-transition:enter.opacity.duration.200ms>
          <label for="friend-input">Add a friend</label>
          <div class="inline-input">
            <input id="friend-input" x-ref="friendInput" x-model="friendUsername" placeholder="Friend's username"
                   @keydown.enter="inviteFriend()" aria-label="Friend's username" />
            <button @click="inviteFriend()">Send Request</button>
          </div>

          <!-- Pending Friend Requests -->
          <div x-show="friendRequests.length > 0" class="friends-list">
            <h4>Friend Requests</h4>
            <ul>
              <template x-for="r in friendRequests" :key="r.id">
                <li>
                  <span class="avatar avatar-sm avatar-inline" :style="{ background: hashColor(r.username) }" x-text="getInitials(r.username)"></span>
                  <span x-text="r.username"></span>
                  <span class="place-actions">
                    <button class="suggest-btn" @click="acceptFriend(r.id)">Accept</button>
                    <button class="remove-btn" @click="rejectFriend(r.id)">Reject</button>
                  </span>
                </li>
              </template>
            </ul>
          </div>

          <!-- Friends List -->
          <div class="friends-list">
            <h4>Friends</h4>
            <!-- Skeleton Loading -->
            <div x-show="loading.friends" class="skeleton-list">
              <div class="skeleton-card skeleton-row"><div class="skeleton-avatar"></div><div class="skeleton-line skeleton-line-md"></div></div>
              <div class="skeleton-card skeleton-row"><div class="skeleton-avatar"></div><div class="skeleton-line skeleton-line-md"></div></div>
              <div class="skeleton-card skeleton-row"><div class="skeleton-avatar"></div><div class="skeleton-line skeleton-line-md"></div></div>
            </div>
            <template x-if="friends.length > 0 && !loading.friends">
              <ul>
                <template x-for="f in friends" :key="f.id">
                  <li>
                    <span class="avatar avatar-sm avatar-inline" :style="{ background: hashColor(f.username) }" x-text="getInitials(f.username)"></span>
                    <span x-text="f.username"></span>
                    <span class="place-actions">
                      <button class="map-btn" @click="viewFriendLikes(f.id, f.username)">View Likes</button>
                      <button class="map-btn" @click="loadCommonPlaces(f.username)">Common Places</button>
                      <button class="suggest-btn" x-show="activeSession && activeSession.session.status === 'open'"
                              @click="quickInviteFriend(f.username)" aria-label="Invite to session">Invite</button>
                      <button class="remove-btn" @click="removeFriend(f.id)" aria-label="Remove friend">Remove</button>
                    </span>
                  </li>
                </template>
              </ul>
            </template>
            <div x-show="friends.length === 0 && !loading.friends" class="empty-state">
              <span class="empty-state-icon">&#x1F465;</span>
              <p>No friends yet.</p>
              <p class="empty-state-hint">Enter a username above and send a friend request.</p>
            </div>
          </div>

          <!-- Friend's Likes View -->
          <div x-show="viewingFriendLikes" class="friends-list">
            <h4 x-text="(viewingFriendLikes?.username || '') + String.fromCharCode(39) + 's Liked Places'"></h4>
            <ul class="place-list">
              <template x-for="(place, idx) in viewingFriendLikes?.likes || []" :key="idx">
                <li>
                  <div class="place-info">
                    <span x-text="place.name"></span>
                    <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                  </div>
                  <span class="place-actions">
                    <button class="suggest-btn"
                            @click="addFriendPlace(place)"
                            :disabled="likes.some(l => l.name === place.name)"
                            x-text="likes.some(l => l.name === place.name) ? 'Already liked' : '+ Add to Likes'"></button>
                    <button class="map-btn" @click="openMap(place.name)">Map</button>
                  </span>
                </li>
              </template>
            </ul>
            <div x-show="viewingFriendLikes?.likes?.length === 0" class="empty-state">
              <span class="empty-state-icon">&#x1F50D;</span>
              <p>This friend hasn't liked any places yet.</p>
              <p class="empty-state-hint">Check back later!</p>
            </div>
            <button class="back-btn" @click="viewingFriendLikes = null">Back</button>
          </div>

          <!-- Common Places -->
          <div x-show="commonFriend">
            <h4 x-text="'Common Places with ' + commonFriend"></h4>
            <template x-if="commonPlaces.length > 0">
              <ul>
                <template x-for="(place, idx) in commonPlaces" :key="idx">
                  <li>
                    <span x-text="place"></span>
                    <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(place)"
                       target="_blank" rel="noopener" class="map-link-small">[Map]</a>
                  </li>
                </template>
              </ul>
            </template>
            <div x-show="commonPlaces.length === 0" class="empty-state">
              <span class="empty-state-icon">&#x1F91D;</span>
              <p>No common places yet.</p>
              <p class="empty-state-hint">Like some of the same restaurants to find common ground.</p>
            </div>
          </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê SESSIONS TAB ‚ïê‚ïê‚ïê -->
        <section x-show="activeTab === 'sessions'" x-transition:enter.opacity.duration.200ms>
          <!-- Personal Suggestions -->
          <div class="suggestions-subsection" style="margin-top: 0; border-top: none; padding-top: 0;">
            <h3>Your Suggestions</h3>
            <ul>
              <template x-for="s in suggestions" :key="s.name">
                <li>
                  <div class="place-info">
                    <span x-text="s.name"></span>
                    <span class="type-badge" x-show="s.restaurant_type" x-text="s.restaurant_type"></span>
                  </div>
                  <span class="place-actions">
                    <a class="reviews-link" x-show="s.place_id" :href="googleReviewsUrl(s.name, s.place_id)"
                       target="_blank" rel="noopener" aria-label="View Google reviews">Reviews</a>
                    <button class="remove-btn" @click="removeSuggestion(s.name)" aria-label="Remove suggestion">Remove</button>
                  </span>
                </li>
              </template>
            </ul>
            <div x-show="suggestions.length === 0" class="empty-state">
              <span class="empty-state-icon">&#x1F4A1;</span>
              <p>No suggestions yet.</p>
              <p class="empty-state-hint">Suggest a liked place to start planning.</p>
            </div>
          </div>

          <!-- Session Management -->
          <div class="session-subsection">
            <h3>Dinner Sessions</h3>
            <div x-show="!activeSession">
              <div class="inline-input">
                <input x-model="newSessionName" placeholder="Session name (e.g., Friday Dinner)"
                       @keydown.enter="createSession()" aria-label="Session name" />
                <button @click="createSession()">Create Session</button>
              </div>
              <div class="inline-input" style="margin-top: 0.5rem;">
                <input x-model="joinCode" placeholder="Enter invite code" maxlength="6"
                       style="text-transform: uppercase;" @keydown.enter="joinSession()" aria-label="Session invite code" />
                <button @click="joinSession()">Join Session</button>
              </div>

              <!-- Active Sessions -->
              <h4 x-show="activeSessions.length > 0">Active Sessions</h4>
              <ul class="session-list">
                <template x-for="s in activeSessions" :key="s.id">
                  <li @click="openSession(s.id)">
                    <div>
                      <strong x-text="s.name"></strong>
                      <span class="session-code" x-text="s.code"></span>
                      <span class="session-creator">
                        <span class="avatar avatar-xs avatar-inline" :style="{ background: hashColor(s.creator_username) }" x-text="getInitials(s.creator_username)"></span>
                        <span x-text="s.creator_username"></span>
                      </span>
                    </div>
                    <div>
                      <span class="member-count" x-text="s.member_count + ' members'"></span>
                      <span class="session-status open">open</span>
                    </div>
                  </li>
                </template>
              </ul>

              <!-- Session History -->
              <h4 x-show="historySessions.length > 0">Session History</h4>
              <ul class="session-list">
                <template x-for="s in historySessions" :key="s.id">
                  <li @click="openSession(s.id)">
                    <div>
                      <strong x-text="s.name"></strong>
                      <span class="session-creator">
                        <span class="avatar avatar-xs avatar-inline" :style="{ background: hashColor(s.creator_username) }" x-text="getInitials(s.creator_username)"></span>
                        <span x-text="s.creator_username"></span>
                      </span>
                      <span class="session-date" x-text="formatDate(s.picked_at || s.created_at)"></span>
                    </div>
                    <div>
                      <span class="member-count" x-text="s.member_count + ' members'"></span>
                      <span x-show="s.winner_place" class="session-winner" x-text="'Winner: ' + s.winner_place"></span>
                      <button class="remove-btn" x-show="s.creator_id === userId"
                              @click.stop="deleteSession(s.id)" aria-label="Delete session">Delete</button>
                    </div>
                  </li>
                </template>
              </ul>
              <!-- Skeleton Loading -->
              <div x-show="loading.sessions" class="skeleton-list">
                <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
                <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
              </div>
              <div x-show="sessions.length === 0 && !loading.sessions" class="empty-state">
                <span class="empty-state-icon">&#x1F46B;</span>
                <p>No sessions yet.</p>
                <p class="empty-state-hint">Create a session or join one with an invite code.</p>
              </div>
            </div>

            <!-- Active Session View -->
            <div x-show="activeSession">
              <div class="session-header">
                <h4 x-text="activeSession?.session?.name"></h4>
                <span class="session-code clickable" @click="copyCode()" x-text="activeSession?.session?.code"
                      title="Click to copy"></span>
                <button class="share-invite-btn" @click="shareSessionInvite()"
                        x-show="activeSession?.session?.status === 'open'">Share Invite</button>
                <button class="back-btn" @click="closeActiveSession()">Back</button>
                <button class="remove-btn" x-show="activeSession?.session?.creator_id === userId && activeSession?.session?.status === 'open' && !closingSession"
                        @click="closeSession()">Close Session</button>
                <button class="back-btn" x-show="closingSession" @click="cancelClose()">Cancel</button>
                <button class="remove-btn" x-show="activeSession?.session?.creator_id === userId && activeSession?.session?.status === 'closed'"
                        @click="deleteSession(activeSession.session.id)">Delete Session</button>
              </div>

              <!-- Members with Avatars -->
              <div class="members-line">
                <strong>Members:</strong>
                <div class="member-chips">
                  <template x-for="m in activeSession?.members || []" :key="m.id">
                    <span class="member-chip">
                      <span class="avatar avatar-xs" :style="{ background: hashColor(m.username) }" x-text="getInitials(m.username)"></span>
                      <span x-text="m.username"></span>
                    </span>
                  </template>
                </div>
              </div>

              <div class="inline-input session-invite-input" x-show="activeSession?.session?.status === 'open'">
                <input x-model="sessionInviteUsername" placeholder="Invite by username..."
                       @keydown.enter="inviteToSession()" aria-label="Invite user to session" />
                <button @click="inviteToSession()">Invite</button>
              </div>
              <p x-show="activeSession?.session?.status === 'closed'" class="closed-badge">This session is closed.</p>

              <!-- Voting Deadline -->
              <div class="deadline-section" x-show="activeSession?.session?.status === 'open'">
                <template x-if="activeSession?.session?.voting_deadline">
                  <div class="deadline-display">
                    <span class="deadline-icon">&#x23F0;</span>
                    <span class="deadline-text" :class="{ urgent: deadlineCountdown.includes('s remaining') && !deadlineCountdown.includes('m') }"
                          x-text="deadlineCountdown || 'Deadline set'"></span>
                    <button class="back-btn btn-sm" x-show="activeSession?.session?.creator_id === userId"
                            @click="removeDeadline()">Remove</button>
                  </div>
                </template>
                <div class="deadline-controls" x-show="!activeSession?.session?.voting_deadline && activeSession?.session?.creator_id === userId">
                  <input type="datetime-local" x-model="deadlineInput" aria-label="Set voting deadline" />
                  <button class="suggest-btn btn-sm" @click="setDeadline()" :disabled="!deadlineInput">Set Deadline</button>
                </div>
              </div>

              <!-- Winner Selection on Close -->
              <div x-show="closingSession" class="close-winner-panel">
                <h4>Select the winning restaurant:</h4>
                <ul class="close-winner-list">
                  <template x-for="s in activeSession?.suggestions || []" :key="s.id">
                    <li @click="closeWithWinner(s.place)">
                      <span class="suggestion-name" x-text="s.place"></span>
                      <span class="type-badge" x-show="s.restaurant_type" x-text="s.restaurant_type"></span>
                      <span class="vote-count"
                            :class="{ 'vote-count-high': s.vote_count >= 3, 'vote-count-med': s.vote_count === 2 }"
                            x-text="s.vote_count + ' vote' + (s.vote_count !== 1 ? 's' : '')"></span>
                    </li>
                  </template>
                </ul>
                <button class="back-btn" @click="closeWithoutWinner()" style="margin-top: 0.5rem;">Close without winner</button>
              </div>

              <!-- Suggest to Session -->
              <div x-show="activeSession?.session?.status === 'open'">
                <h4>Suggest a Place</h4>
                <div class="autocomplete-container">
                  <input placeholder="Search for a restaurant..." autocomplete="off"
                         x-model="sessionPlaceSearch" @input.debounce.300ms="searchSessionPlaces()"
                         @keydown.escape="sessionPredictions = []; sessionHighlightedIndex = -1"
                         @keydown.arrow-down.prevent="handleSessionKeydown($event)"
                         @keydown.arrow-up.prevent="handleSessionKeydown($event)"
                         @keydown.enter.prevent="handleSessionKeydown($event)"
                         aria-label="Search to suggest a restaurant"
                         role="combobox" aria-expanded="false" :aria-expanded="sessionPredictions.length > 0"
                         :aria-activedescendant="sessionHighlightedIndex >= 0 ? 'session-opt-' + sessionHighlightedIndex : null" />
                  <span class="spinner" x-show="sessionSearching"></span>
                  <ul class="autocomplete-list" x-show="sessionPredictions.length > 0" role="listbox">
                    <template x-for="(pred, index) in sessionPredictions" :key="pred.place_id">
                      <li @click="suggestToSession(pred.description, pred.place_id, formatPlaceType(pred.types))"
                          role="option" tabindex="0" :id="'session-opt-' + index"
                          :class="{ 'highlighted': index === sessionHighlightedIndex }">
                        <span x-text="pred.description"></span>
                        <span class="dislike-warn-badge" x-show="isSessionDisliked(pred.description)">Disliked by member</span>
                      </li>
                    </template>
                  </ul>
                  <p class="no-results" x-show="sessionPredictions.length === 0 && sessionPlaceSearch.length > 2 && sessionSearchedOnce">
                    No results found. Try a different search term.
                  </p>
                </div>

                <!-- Recently Suggested Quick-Add -->
                <div x-show="recentSuggestions.length > 0" class="recent-suggest-section">
                  <span class="grid-label">Recently suggested:</span>
                  <div class="recent-suggest-grid">
                    <template x-for="rs in recentSuggestions" :key="rs.name">
                      <button class="recent-suggest-btn" @click="suggestToSession(rs.name, rs.place_id, rs.restaurant_type)"
                              :aria-label="'Suggest ' + rs.name" x-text="'+ ' + rs.name"></button>
                    </template>
                  </div>
                </div>

                <div x-show="likes.length > 0" class="liked-suggest-grid">
                  <span class="grid-label">Quick suggest from likes:</span>
                  <template x-for="place in likes" :key="place.name">
                    <button class="suggest-btn" @click="suggestToSession(place.name, place.place_id, place.restaurant_type)"
                            :aria-label="'Suggest ' + place.name">
                      <span x-text="'+ ' + place.name"></span>
                      <span class="dislike-warn-badge" x-show="isSessionDisliked(place.name)">!</span>
                    </button>
                  </template>
                </div>

                <div x-show="wantToTry.length > 0" class="liked-suggest-grid">
                  <span class="grid-label">From your bucket list:</span>
                  <template x-for="place in wantToTry" :key="place.name">
                    <button class="want-to-try-quick-btn" @click="suggestToSession(place.name, place.place_id, place.restaurant_type)"
                            :aria-label="'Suggest ' + place.name">
                      <span x-text="'‚≠ê ' + place.name"></span>
                    </button>
                  </template>
                </div>
              </div>

              <!-- Session Suggestions with Votes -->
              <h4>Suggestions <span class="vote-hint" x-show="activeSession?.suggestions?.length > 0">(click Vote to upvote)</span></h4>

              <!-- Cuisine Filter Chips -->
              <div class="cuisine-filter-chips" x-show="uniqueSessionCuisines.length > 1">
                <button class="filter-chip" :class="{ active: sessionCuisineFilter === '' }"
                        @click="sessionCuisineFilter = ''">All</button>
                <template x-for="cuisine in uniqueSessionCuisines" :key="cuisine">
                  <button class="filter-chip" :class="{ active: sessionCuisineFilter === cuisine }"
                          @click="sessionCuisineFilter = cuisine" x-text="cuisine"></button>
                </template>
              </div>

              <div class="sort-controls" x-show="activeSession?.suggestions?.length > 1">
                <button class="sort-btn" :class="{ active: sessionSuggestSort === 'votes' }" @click="sessionSuggestSort = 'votes'">By Votes</button>
                <button class="sort-btn" :class="{ active: sessionSuggestSort === 'name' }" @click="sessionSuggestSort = 'name'">By Name</button>
                <button class="sort-btn" :class="{ active: sessionSuggestSort === 'suggester' }" @click="sessionSuggestSort = 'suggester'">By Suggester</button>
              </div>

              <!-- List/Map View Toggle -->
              <div class="view-toggle" x-show="activeSession?.suggestions?.some(s => s.lat != null)">
                <button :class="{ active: !mapView }" @click="mapView = false">List</button>
                <button :class="{ active: mapView }" @click="toggleMapView()">Map</button>
              </div>

              <!-- Map View -->
              <div x-show="mapView">
                <div id="session-map" class="session-map"></div>
                <div class="map-legend">
                  <template x-for="(s, idx) in (activeSession?.suggestions || []).filter(s => s.lat != null)" :key="s.id">
                    <span class="map-legend-item">
                      <span class="legend-number" x-text="idx + 1"></span>
                      <span x-text="s.place"></span>
                    </span>
                  </template>
                </div>
              </div>

              <!-- List View -->
              <ul class="session-suggestion-list" x-show="!mapView">
                <template x-for="s in sortedSessionSuggestions" :key="s.id">
                  <li>
                    <div class="suggestion-info">
                      <span class="suggestion-name" x-text="s.place"></span>
                      <span class="want-to-try-badge" x-show="isWantToTry(s.place)"
                            :title="getWantToTryUsers(s.place).map(u => u.username).join(', ') + ' want' + (getWantToTryUsers(s.place).length === 1 ? 's' : '') + ' to try this'">
                        ‚≠ê
                        <template x-for="u in getWantToTryUsers(s.place).slice(0, 3)" :key="u.user_id">
                          <span class="avatar avatar-xxs avatar-inline" :style="{ background: hashColor(u.username) }" x-text="getInitials(u.username)"></span>
                        </template>
                      </span>
                      <span class="type-badge" x-show="s.restaurant_type" x-text="s.restaurant_type"></span>
                      <span class="price-badge" x-show="s.price_level" x-text="priceDisplay(s.price_level)"></span>
                      <span class="suggestion-by">
                        <span class="avatar avatar-xs avatar-inline" :style="{ background: hashColor(s.suggested_by) }" x-text="getInitials(s.suggested_by)"></span>
                        <span x-text="s.suggested_by"></span>
                      </span>
                    </div>
                    <div class="suggestion-actions">
                      <span class="vote-count"
                            :class="{ 'vote-count-high': s.vote_count >= 3, 'vote-count-med': s.vote_count === 2 }"
                            x-text="s.vote_count + ' vote' + (s.vote_count !== 1 ? 's' : '')"></span>
                      <button class="vote-btn" :class="{ voted: s.user_voted }"
                              @click="toggleVote(s)" x-text="s.user_voted ? 'Voted' : 'Vote'"
                              :aria-label="s.user_voted ? 'Remove vote' : 'Vote for ' + s.place"
                              x-show="activeSession?.session?.status === 'open'"></button>
                      <a class="reviews-link" x-show="s.place_id" :href="googleReviewsUrl(s.place, s.place_id)"
                         target="_blank" rel="noopener" aria-label="View Google reviews">Reviews</a>
                      <button class="map-btn" @click="openMap(s.place)" aria-label="View on map">Map</button>
                    </div>
                  </li>
                </template>
              </ul>
              <div x-show="!activeSession?.suggestions?.length" class="empty-state">
                <span class="empty-state-icon">&#x1F4DD;</span>
                <p>No suggestions yet.</p>
                <p class="empty-state-hint">Search for a restaurant or quick-suggest from your likes.</p>
              </div>

              <!-- Pick Buttons -->
              <div class="buttons pick-buttons" x-show="activeSession?.suggestions?.length > 0 && activeSession?.session?.status === 'open'">
                <button @click="randomPick()" :disabled="picking" aria-label="Random pick weighted by votes">üé≤ Random Pick</button>
                <button @click="closestPick()" :disabled="picking" aria-label="Pick the closest restaurant">üìç Closest</button>
              </div>

              <!-- Winner Display -->
              <div class="winner-display" x-show="winner" x-transition>
                <h3 x-text="winner?.place" id="winner-text"></h3>
                <p x-show="winner?.distance != null" x-text="winnerDistanceText"></p>
                <a :href="winnerMapUrl" target="_blank" rel="noopener"
                   x-text="winner?.distance != null ? 'Get Directions' : 'View on Google Maps'"></a>
                <button class="share-btn" @click="shareWinner()">Share Result</button>
                <!-- Session Recap -->
                <div class="session-recap" x-show="sessionRecap">
                  <div class="recap-stat">
                    <span class="recap-label">Suggestions</span>
                    <span x-text="sessionRecap?.totalSuggestions"></span>
                  </div>
                  <div class="recap-stat">
                    <span class="recap-label">Total Votes</span>
                    <span x-text="sessionRecap?.totalVotes"></span>
                  </div>
                  <div class="recap-stat">
                    <span class="recap-label">Suggested by</span>
                    <span x-text="sessionRecap?.suggestedBy"></span>
                  </div>
                  <div x-show="sessionRecap?.topPlaces?.length > 1">
                    <span class="recap-label">Top Picks</span>
                    <template x-for="tp in sessionRecap?.topPlaces || []" :key="tp.place">
                      <span class="recap-place" x-text="tp.place + ' (' + tp.vote_count + 'v)'"></span>
                    </template>
                  </div>
                </div>
              </div>

              <!-- Session Chat -->
              <div class="chat-section">
                <button class="chat-toggle" @click="chatVisible = !chatVisible">
                  <span x-text="chatVisible ? '‚ñº Chat' : '‚ñ∂ Chat'"></span>
                  <span class="chat-badge" x-show="chatMessages.length > 0" x-text="chatMessages.length"></span>
                </button>
                <div x-show="chatVisible" x-collapse>
                  <div id="chat-messages" class="chat-messages">
                    <div x-show="chatMessages.length === 0" class="chat-empty">
                      No messages yet. Start the conversation!
                    </div>
                    <template x-for="msg in chatMessages" :key="msg.id">
                      <div class="chat-message" :class="{ own: msg.user_id === userId }">
                        <span class="chat-avatar avatar avatar-xs" :style="{ background: hashColor(msg.username) }" x-text="getInitials(msg.username)"></span>
                        <div class="chat-bubble">
                          <div class="chat-bubble-name" x-show="msg.user_id !== userId" x-text="msg.username"></div>
                          <div x-text="msg.message"></div>
                          <div class="chat-bubble-time" x-text="formatChatTime(msg.created_at)"></div>
                        </div>
                      </div>
                    </template>
                  </div>
                  <div class="chat-input-wrapper">
                    <input x-model="chatInput" placeholder="Type a message..." maxlength="500"
                           @keydown.enter="sendChatMessage()" aria-label="Chat message" />
                    <button class="suggest-btn" @click="sendChatMessage()" :disabled="!chatInput.trim()">Send</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê ACCOUNT TAB ‚ïê‚ïê‚ïê -->
        <section x-show="activeTab === 'account'" x-transition:enter.opacity.duration.200ms>
          <h3>Account Settings</h3>

          <h4>Update Email</h4>
          <p style="font-size: 0.9rem; color: var(--text-secondary);">Current: <span x-text="email || 'Not set'"></span></p>
          <div class="inline-input">
            <input type="email" x-model="accountForm.newEmail" placeholder="New email address"
                   @keydown.enter="updateEmail()" aria-label="New email address" />
            <button @click="updateEmail()">Update</button>
          </div>

          <h4>Change Password</h4>
          <input type="password" x-model="accountForm.currentPassword" placeholder="Current password" aria-label="Current password" />
          <input type="password" x-model="accountForm.newPassword" placeholder="New password (min 6 chars)" aria-label="New password" />
          <input type="password" x-model="accountForm.confirmNewPassword" placeholder="Confirm new password"
                 aria-label="Confirm new password" />
          <p class="auth-error" x-show="accountForm.newPassword && accountForm.confirmNewPassword && accountForm.newPassword !== accountForm.confirmNewPassword">
            Passwords do not match.
          </p>
          <button @click="changePassword()"
                  :disabled="!accountForm.currentPassword || !accountForm.newPassword || accountForm.newPassword !== accountForm.confirmNewPassword">Change Password</button>

          <h4>Notifications</h4>
          <p x-show="!notificationsSupported" class="warning-text">Push notifications are not supported in this browser.</p>
          <div x-show="notificationsSupported">
            <button @click="notificationsEnabled ? disableNotifications() : enableNotifications()"
                    x-text="notificationsEnabled ? 'Disable Notifications' : 'Enable Notifications'"
                    :class="notificationsEnabled ? 'remove-btn' : 'suggest-btn'"></button>
            <p class="notification-hint" x-show="notificationsEnabled">You'll receive notifications for session updates, friend requests, and more.</p>
          </div>

          <h4 class="danger-zone">Delete Account</h4>
          <p class="warning-text">This will permanently delete your account and all data.</p>
          <input type="password" x-model="accountForm.deletePassword" placeholder="Enter password to confirm" aria-label="Password to confirm deletion" />
          <button class="remove-btn" @click="deleteAccount()">Delete My Account</button>
        </section>

        <!-- ‚ïê‚ïê‚ïê ADMIN TAB ‚ïê‚ïê‚ïê -->
        <section x-show="activeTab === 'admin' && isAdmin" x-transition:enter.opacity.duration.200ms
                 x-init="$watch('activeTab', val => { if (val === 'admin') switchAdminTab(adminTab); })">
          <h3>Admin Panel</h3>

          <!-- Admin Sub-tabs -->
          <div class="admin-sub-tabs">
            <button class="admin-sub-tab" :class="{ active: adminTab === 'dashboard' }" @click="switchAdminTab('dashboard')">Dashboard</button>
            <button class="admin-sub-tab" :class="{ active: adminTab === 'users' }" @click="switchAdminTab('users')">Users</button>
            <button class="admin-sub-tab" :class="{ active: adminTab === 'smtp' }" @click="switchAdminTab('smtp')">SMTP</button>
            <button class="admin-sub-tab" :class="{ active: adminTab === 'vapid' }" @click="switchAdminTab('vapid')">VAPID</button>
            <button class="admin-sub-tab" :class="{ active: adminTab === 'settings' }" @click="switchAdminTab('settings')">Settings</button>
          </div>

          <!-- Dashboard Sub-tab -->
          <div x-show="adminTab === 'dashboard'">
            <div x-show="!adminStats" class="empty-state">
              <p>Loading stats...</p>
            </div>
            <div x-show="adminStats" class="admin-stats-grid">
              <div class="admin-stat-card">
                <div class="admin-stat-value" x-text="adminStats?.users ?? '-'"></div>
                <div class="admin-stat-label">Users</div>
              </div>
              <div class="admin-stat-card">
                <div class="admin-stat-value" x-text="adminStats?.sessions ?? '-'"></div>
                <div class="admin-stat-label">Sessions</div>
              </div>
              <div class="admin-stat-card">
                <div class="admin-stat-value" x-text="adminStats?.active_sessions ?? '-'"></div>
                <div class="admin-stat-label">Active Sessions</div>
              </div>
              <div class="admin-stat-card">
                <div class="admin-stat-value" x-text="adminStats?.places ?? '-'"></div>
                <div class="admin-stat-label">Places</div>
              </div>
            </div>
            <div x-show="adminStats" style="margin-top: 1rem;">
              <div class="admin-form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
                <span>SMTP:</span>
                <span class="admin-status-indicator" :class="adminStats?.smtp_configured ? 'configured' : 'not-configured'"></span>
                <span x-text="adminStats?.smtp_configured ? 'Configured' : 'Not configured'"
                      :style="{ color: adminStats?.smtp_configured ? 'var(--success)' : 'var(--danger)' }"></span>
              </div>
              <div class="admin-form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
                <span>VAPID:</span>
                <span class="admin-status-indicator" :class="adminStats?.vapid_source !== 'none' ? 'configured' : 'not-configured'"></span>
                <span x-text="adminStats?.vapid_source ? ('Source: ' + adminStats.vapid_source) : 'Not configured'"
                      :style="{ color: adminStats?.vapid_source && adminStats.vapid_source !== 'none' ? 'var(--success)' : 'var(--danger)' }"></span>
              </div>
            </div>
          </div>

          <!-- Users Sub-tab -->
          <div x-show="adminTab === 'users'">
            <div x-show="adminUsers.length === 0" class="empty-state">
              <p>No users found.</p>
            </div>
            <div class="admin-user-list">
              <template x-for="u in adminUsers" :key="u.id">
                <div class="admin-user-row">
                  <div class="admin-user-info">
                    <span class="avatar avatar-sm" :style="{ background: hashColor(u.username) }" x-text="getInitials(u.username)"></span>
                    <div class="admin-user-details">
                      <strong x-text="u.username"></strong>
                      <span class="admin-user-email" x-text="u.email || 'No email'"></span>
                      <span class="admin-user-meta">
                        <span class="type-badge" x-show="u.is_admin">Admin</span>
                        <span class="admin-user-date" x-text="'Joined ' + formatDate(u.created_at)"></span>
                      </span>
                    </div>
                  </div>
                  <div class="admin-user-actions" x-show="u.id !== userId">
                    <button class="map-btn btn-sm" @click="adminResetPassword(u.id)"
                            x-text="adminResetPwUser === u.id ? 'Confirm Reset' : 'Reset PW'"></button>
                    <button class="back-btn btn-sm" x-show="adminResetPwUser === u.id"
                            @click="adminCancelResetPassword()">Cancel</button>
                    <button class="suggest-btn btn-sm" @click="adminToggleAdmin(u.id)"
                            x-text="u.is_admin ? 'Remove Admin' : 'Make Admin'"></button>
                    <button class="remove-btn btn-sm" @click="adminDeleteUser(u.id)">Delete</button>
                  </div>
                  <div class="admin-user-actions" x-show="u.id === userId">
                    <span class="type-badge" style="background: var(--accent); color: white;">You</span>
                  </div>
                  <!-- Inline password reset input -->
                  <div class="admin-reset-pw-inline" x-show="adminResetPwUser === u.id">
                    <input type="password" x-model="adminResetPwValue" placeholder="New password (min 6 chars)"
                           @keydown.enter="adminResetPassword(u.id)" aria-label="New password for user" />
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- SMTP Sub-tab -->
          <div x-show="adminTab === 'smtp'">
            <div class="admin-form-group">
              <label for="admin-smtp-host">SMTP Host</label>
              <input id="admin-smtp-host" x-model="adminSmtp.host" placeholder="smtp.example.com" />
            </div>
            <div class="admin-form-group">
              <label for="admin-smtp-port">Port</label>
              <input id="admin-smtp-port" type="number" x-model.number="adminSmtp.port" placeholder="587" />
            </div>
            <div class="admin-form-group">
              <label for="admin-smtp-user">Username</label>
              <input id="admin-smtp-user" x-model="adminSmtp.user" placeholder="user@example.com" />
            </div>
            <div class="admin-form-group">
              <label for="admin-smtp-password">Password</label>
              <input id="admin-smtp-password" type="password" x-model="adminSmtp.password"
                     placeholder="Leave blank to keep existing" />
            </div>
            <div class="admin-form-group">
              <label for="admin-smtp-from">From Address</label>
              <input id="admin-smtp-from" x-model="adminSmtp.from" placeholder="noreply@example.com" />
            </div>
            <div class="admin-form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="admin-smtp-secure" x-model="adminSmtp.secure" style="width: auto;" />
              <label for="admin-smtp-secure" style="margin: 0;">Use TLS/SSL</label>
            </div>
            <div class="buttons">
              <button @click="saveAdminSmtp()">Save SMTP Settings</button>
            </div>

            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-light);">
              <h4>Send Test Email</h4>
              <div class="inline-input">
                <input type="email" x-model="adminTestEmail" placeholder="test@example.com"
                       @keydown.enter="testSmtp()" aria-label="Test email address" />
                <button @click="testSmtp()">Send Test</button>
              </div>
            </div>
          </div>

          <!-- VAPID Sub-tab -->
          <div x-show="adminTab === 'vapid'">
            <div class="admin-form-group">
              <label>Public Key</label>
              <div class="admin-key-display" x-text="adminVapid.publicKey || 'No VAPID key configured'"></div>
            </div>
            <div class="admin-form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
              <span>Source:</span>
              <span class="type-badge" x-text="adminVapid.source || 'none'"></span>
            </div>
            <div class="buttons" style="margin-top: 1rem;">
              <button class="remove-btn" @click="generateVapid()">Generate New VAPID Keys</button>
            </div>
            <p class="warning-text" style="margin-top: 0.5rem;">
              Generating new keys will break all existing push notification subscriptions.
              Users will need to re-enable notifications.
            </p>
          </div>

          <!-- Settings Sub-tab -->
          <div x-show="adminTab === 'settings'">
            <div class="admin-form-group">
              <label for="admin-google-key">Google API Key</label>
              <div class="admin-key-display" x-show="adminGoogleKey" x-text="adminGoogleKey"></div>
              <input id="admin-google-key" x-model="adminGoogleKey" placeholder="Enter Google API key" />
              <button class="suggest-btn btn-sm" @click="saveAdminGoogleKey()" style="margin-top: 0.3rem;">Save API Key</button>
            </div>

            <div class="admin-form-group">
              <label for="admin-jwt-expiry">JWT Token Expiry</label>
              <select id="admin-jwt-expiry" class="filter-select" x-model="adminSettings.jwt_expiry">
                <option value="1h">1 hour</option>
                <option value="6h">6 hours</option>
                <option value="12h">12 hours</option>
                <option value="24h">24 hours</option>
                <option value="7d">7 days</option>
              </select>
            </div>

            <div class="admin-form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="admin-cookie-secure" style="width: auto;"
                     :checked="adminSettings.cookie_secure === 'true'"
                     @change="adminSettings.cookie_secure = $event.target.checked ? 'true' : 'false'" />
              <label for="admin-cookie-secure" style="margin: 0;">Cookie Secure flag (requires HTTPS)</label>
            </div>

            <div class="buttons" style="margin-top: 1rem;">
              <button @click="saveAdminSettings()">Save Settings</button>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js', { updateViaCache: 'none' });
    }
  </script>
</body>
</html>
