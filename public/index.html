<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dinner Roulette</title>
  <meta name="theme-color" content="#E07A5F" />
  <meta name="description" content="Collaboratively pick a restaurant with friends" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Dinner Roulette" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="stylesheet" href="/styles.css" />
  <link rel="icon" href="/icon-192.png" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1/qrcode.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3/dist/cdn.min.js"></script>
  <script defer src="/app.js?v=18"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js"></script>
</head>
<body>
  <div x-data="dinnerRoulette()" x-init="init()">

    <!-- Toast -->
    <div class="toast" x-show="toast.visible" x-transition.opacity.duration.300ms
         :class="toast.type">
      <span x-text="toast.message"></span>
      <button class="toast-action" x-show="toast.action" x-text="toast.action?.label"
              @click="toast.action?.callback()"></button>
    </div>

    <!-- Offline Banner -->
    <div class="offline-banner" x-show="!online" x-transition.opacity>
      You are offline. Some features may be unavailable.
    </div>

    <!-- Confirm Modal -->
    <div class="confirm-overlay" x-show="confirmModal.visible" x-transition.opacity.duration.200ms
         @click.self="confirmModal.onCancel()">
      <div class="confirm-modal" x-show="confirmModal.visible" x-transition.scale.origin.center role="dialog" aria-modal="true">
        <p x-text="confirmModal.message"></p>
        <div class="confirm-modal-actions">
          <button class="back-btn" @click="confirmModal.onCancel()">Cancel</button>
          <button class="remove-btn" @click="confirmModal.onConfirm()">Confirm</button>
        </div>
      </div>
    </div>

    <!-- QR Code Modal -->
    <div class="qr-overlay" x-show="qrModal.visible" x-transition.opacity.duration.200ms
         @click.self="qrModal.visible = false">
      <div class="qr-modal" x-show="qrModal.visible" x-transition.scale.origin.center role="dialog" aria-modal="true" aria-labelledby="qr-modal-title">
        <h3 id="qr-modal-title">Scan to Join</h3>
        <p class="qr-plan-name" x-text="activePlan?.plan?.name"></p>
        <div class="qr-code-container">
          <img :src="qrModal.dataUrl" alt="QR code for plan invite" x-show="qrModal.dataUrl" />
        </div>
        <p class="qr-code-display" x-text="activePlan?.plan?.code"></p>
        <div class="qr-modal-actions">
          <button class="back-btn" @click="downloadQr()">Save Image</button>
          <button @click="qrModal.visible = false">Close</button>
        </div>
      </div>
    </div>

    <!-- Onboarding Walkthrough -->
    <div class="onboarding-overlay" x-show="onboarding.active" x-transition.opacity.duration.300ms>
      <div class="onboarding-tooltip">
        <p class="onboarding-text" x-text="onboardingSteps[onboarding.step]?.text"></p>
        <div class="onboarding-dots">
          <template x-for="(s, i) in onboardingSteps" :key="i">
            <span class="onboarding-dot" :class="{ active: i === onboarding.step, done: i < onboarding.step }"></span>
          </template>
        </div>
        <div class="onboarding-actions">
          <button class="back-btn" @click="skipOnboarding()" x-show="onboarding.step < onboardingSteps.length - 1">Skip</button>
          <button @click="nextOnboardingStep()" x-text="onboarding.step >= onboardingSteps.length - 1 ? 'Get Started' : 'Next'"></button>
        </div>
      </div>
    </div>

    <!-- Post-Login Prompt Modal -->
    <div class="confirm-overlay" x-show="promptModal.visible" x-transition.opacity.duration.200ms>
      <!-- Email Prompt -->
      <div class="confirm-modal prompt-modal" x-show="promptModal.type === 'email'" x-transition.scale.origin.center>
        <h3 class="prompt-title">Add Your Email</h3>
        <p class="prompt-text">Add an email address so you can reset your password if you forget it.</p>
        <input type="email" class="prompt-input" x-model="promptEmailValue" placeholder="you@example.com"
               @keydown.enter="promptModal.onSubmit?.()" aria-label="Email address" />
        <div class="confirm-modal-actions">
          <button class="back-btn" @click="promptModal.onSkip?.()">Skip</button>
          <button class="suggest-btn" @click="promptModal.onSubmit?.()" :disabled="!promptEmailValue.trim()">Save Email</button>
        </div>
      </div>
      <!-- Notification Prompt -->
      <div class="confirm-modal prompt-modal" x-show="promptModal.type === 'notifications'" x-transition.scale.origin.center>
        <h3 class="prompt-title">Enable Notifications</h3>
        <p class="prompt-text">Get notified when friends join your plans, votes come in, and dinner is decided!</p>
        <div class="confirm-modal-actions prompt-actions-stacked">
          <button class="suggest-btn" @click="promptModal.onEnable?.()">Enable Notifications</button>
          <button class="back-btn" @click="promptModal.onNotNow?.()">Not Now</button>
          <button class="prompt-dismiss-link" @click="promptModal.onDontAskAgain?.()">Don't Ask Again</button>
        </div>
      </div>
    </div>

    <header>
      <div class="header-content">
        <img src="icon-192.png" alt="Dinner Roulette Logo" class="logo" />
        <h1>Dinner Roulette</h1>
        <div class="header-actions" x-show="loggedIn">
          <button class="theme-toggle" @click="toggleTheme()" :aria-label="theme === 'auto' ? 'Switch to light mode' : theme === 'light' ? 'Switch to dark mode' : 'Switch to auto mode'">
            <span x-text="theme === 'auto' ? 'üíª' : theme === 'light' ? '‚òÄÔ∏è' : 'üåô'"></span>
          </button>
          <span class="avatar avatar-sm" :class="{ 'avatar-pic': profilePic }" :style="avatarStyle({ username, profile_pic: profilePic, display_name: profileName })" x-text="profilePic ? '' : getInitials(profileName || username)"></span>
          <span class="username-badge" x-text="profileName || username"></span>
          <button class="logout-btn" @click="logout()">Logout</button>
        </div>
      </div>
    </header>

    <main>
      <!-- Invite Banner (for logged-out users with pending invite) -->
      <div class="invite-banner" x-show="!loggedIn && pendingInviteCode">
        <p>You've been invited to a Dinner Roulette plan!</p>
        <p class="invite-code-display" x-text="pendingInviteCode"></p>
        <p class="invite-hint">Log in or register below to join the plan.</p>
      </div>

      <!-- Authentication -->
      <section x-show="!loggedIn">
        <!-- Password Reset Token Form -->
        <div x-show="resetMode && resetToken">
          <h3>Reset Password</h3>
          <div x-show="resetTokenValid">
            <p style="color: var(--text-secondary);">Resetting password for <strong x-text="resetUsername"></strong></p>
            <label>New Password</label>
            <input type="password" x-model="resetNewPassword" placeholder="New password (min 6 chars)"
                   @keydown.enter="$refs.resetConfirm.focus()" aria-label="New password" />
            <label>Confirm Password</label>
            <input type="password" x-ref="resetConfirm" x-model="resetConfirmPassword" placeholder="Confirm password"
                   @keydown.enter="submitPasswordReset()" aria-label="Confirm password" />
            <p class="auth-error" x-show="resetNewPassword && resetConfirmPassword && resetNewPassword !== resetConfirmPassword">
              Passwords do not match.
            </p>
            <div class="buttons">
              <button @click="submitPasswordReset()"
                      :disabled="!resetNewPassword || resetNewPassword !== resetConfirmPassword">Reset Password</button>
            </div>
          </div>
          <div x-show="!resetTokenValid">
            <p class="warning-text">This reset link is invalid or has expired.</p>
          </div>
          <p class="auth-error" x-show="authError" x-text="authError"></p>
          <p><a href="#" @click.prevent="resetMode = false; resetToken = ''; window.history.replaceState(null, '', '/')">Back to login</a></p>
        </div>

        <!-- Forgot Password Form -->
        <div x-show="resetMode && !resetToken">
          <h3>Forgot Password</h3>
          <p style="color: var(--text-secondary); font-size: 0.9rem;">Enter your email address and we'll send you a link to reset your password.</p>
          <label for="reset-email">Email</label>
          <input id="reset-email" x-model="resetEmail" type="email" placeholder="Your email address"
                 @keydown.enter="forgotPassword()" aria-label="Email for password reset" />
          <div class="buttons">
            <button @click="forgotPassword()">Send Reset Link</button>
            <button class="back-btn" @click="resetMode = false">Back</button>
          </div>
          <p class="auth-error" x-show="authError" x-text="authError"></p>
        </div>

        <!-- Normal Auth (Login/Register) -->
        <div x-show="!resetMode">
          <div class="auth-tabs">
            <button class="auth-tab" :class="{ active: authMode === 'login' }" @click="authMode = 'login'; authError = ''">Login</button>
            <button class="auth-tab" :class="{ active: authMode === 'register' }" @click="authMode = 'register'; authError = ''">Register</button>
          </div>

          <!-- Login Form -->
          <div x-show="authMode === 'login'">
            <label for="auth-username">Username</label>
            <input id="auth-username" x-model="authForm.username" placeholder="Username"
                   @keydown.enter="$refs.loginPass.focus()" aria-label="Username" />
            <label for="auth-password">Password</label>
            <input id="auth-password" x-ref="loginPass" x-model="authForm.password" type="password"
                   placeholder="Password" @keydown.enter="login()" aria-label="Password" />
            <div class="remember-wrapper">
              <label for="remember-me">
                <input type="checkbox" id="remember-me" x-model="authForm.remember" />
                Remember Me
              </label>
            </div>
            <div class="buttons">
              <button @click="login()">Login</button>
            </div>
            <p><a href="#" @click.prevent="resetMode = true; authError = ''">Forgot Password?</a></p>
          </div>

          <!-- Register Form -->
          <div x-show="authMode === 'register'">
            <label for="reg-username">Username</label>
            <input id="reg-username" x-model="authForm.username" placeholder="Username"
                   @keydown.enter="$refs.regEmail.focus()" aria-label="Username" />
            <label for="reg-email">Email</label>
            <input id="reg-email" x-ref="regEmail" x-model="authForm.email" type="email" placeholder="Email address"
                   @keydown.enter="$refs.regPass.focus()" aria-label="Email address" />
            <label for="reg-password">Password</label>
            <input id="reg-password" x-ref="regPass" x-model="authForm.password" type="password"
                   placeholder="Password (min 6 chars)" @keydown.enter="$refs.regConfirm.focus()" aria-label="Password" />
            <label for="reg-confirm">Confirm Password</label>
            <input id="reg-confirm" x-ref="regConfirm" x-model="authForm.confirmPassword" type="password"
                   placeholder="Confirm password" @keydown.enter="register()" aria-label="Confirm password" />
            <p class="auth-error" x-show="authForm.password && authForm.confirmPassword && authForm.password !== authForm.confirmPassword">
              Passwords do not match.
            </p>
            <div class="remember-wrapper">
              <label for="reg-remember">
                <input type="checkbox" id="reg-remember" x-model="authForm.remember" />
                Remember Me
              </label>
            </div>
            <div class="buttons">
              <button @click="register()"
                      :disabled="!authForm.username || !authForm.password || !authForm.email || authForm.password !== authForm.confirmPassword">Register</button>
            </div>
          </div>
          <p class="auth-error" x-show="authError" x-text="authError"></p>
        </div>
      </section>

      <!-- Tab Bar -->
      <nav class="tab-bar" x-show="loggedIn" role="tablist">
        <button class="tab-btn" :class="{ active: activeTab === 'places' }" @click="switchTab('places')" role="tab" aria-label="Places">
          <span class="tab-btn-icon">&#x1F37D;</span>
          <span class="tab-btn-label">Places</span>
        </button>
        <button class="tab-btn" :class="{ active: activeTab === 'friends' }" @click="switchTab('friends')" role="tab" aria-label="Friends">
          <span class="tab-btn-icon">&#x1F465;</span>
          <span class="tab-btn-label">Friends</span>
          <span class="tab-badge" x-show="friendRequests.length > 0" x-text="friendRequests.length"></span>
        </button>
        <button class="tab-btn" :class="{ active: activeTab === 'plans' }" @click="switchTab('plans')" role="tab" aria-label="Plans">
          <span class="tab-btn-icon">&#x1F3B2;</span>
          <span class="tab-btn-label">Plans</span>
          <span class="tab-badge" x-show="activePlans.length > 0" x-text="activePlans.length"></span>
        </button>
        <button class="tab-btn" :class="{ active: activeTab === 'account' }" @click="switchTab('account')" role="tab" aria-label="Account">
          <span class="tab-btn-icon">&#x2699;</span>
          <span class="tab-btn-label">Account</span>
        </button>
        <button class="tab-btn" :class="{ active: activeTab === 'admin' }" @click="switchTab('admin')" role="tab" aria-label="Admin"
                x-show="isAdmin">
          <span class="tab-btn-icon">&#x1F6E1;</span>
          <span class="tab-btn-label">Admin</span>
        </button>
      </nav>

      <!-- Speed Dial FAB -->
      <div class="speed-dial-container"
           x-show="loggedIn && activeTab !== 'account' && activeTab !== 'admin'">
        <!-- Backdrop -->
        <div class="speed-dial-backdrop" x-show="speedDialOpen" @click="speedDialOpen = false"
             x-transition.opacity></div>
        <!-- Actions -->
        <div class="speed-dial-actions" x-show="speedDialOpen" x-transition>
          <!-- Chat (when viewing a plan) -->
          <button class="speed-dial-action" x-show="activePlan"
                  @click="toggleChatDrawer(); speedDialOpen = false" aria-label="Open chat">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H5.17L4 17.17V4h16v12z"/><path d="M7 9h2v2H7zm4 0h2v2h-2zm4 0h2v2h-2z"/></svg>
            <span class="speed-dial-label">Chat</span>
            <span class="speed-dial-badge" x-show="unreadChatCount > 0" x-text="unreadChatCount"></span>
          </button>
          <!-- Go to active plan (when not on plans tab) -->
          <button class="speed-dial-action"
                  x-show="plans.some(p => p.status === 'open') && activeTab !== 'plans'"
                  @click="goToActivePlan(); speedDialOpen = false" aria-label="Go to active plan">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
            <span class="speed-dial-label" x-text="(() => { const open = plans.filter(p => p.status === 'open'); return open.length === 1 ? open[0].name : open.length + ' Plans'; })()"></span>
          </button>
          <!-- Primary action -->
          <button class="speed-dial-action" @click="fabAction(); speedDialOpen = false"
                  :aria-label="activeTab === 'places' ? 'Add place' : activeTab === 'friends' ? 'Add friend' : 'Quick plan'">
            <svg x-show="activeTab === 'plans'" class="roulette-icon" viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="12" r="7" fill="none" stroke="currentColor" stroke-width="1"/><circle cx="12" cy="12" r="1.5"/><line x1="12" y1="2" x2="12" y2="5" stroke="currentColor" stroke-width="1.5"/><line x1="12" y1="5" x2="12" y2="12" stroke="currentColor" stroke-width="0.75"/><line x1="12" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="0.75"/><line x1="12" y1="12" x2="7" y2="18" stroke="currentColor" stroke-width="0.75"/><line x1="12" y1="12" x2="7" y2="6" stroke="currentColor" stroke-width="0.75"/></svg>
            <span x-show="activeTab !== 'plans'" style="font-size:1.2rem">+</span>
            <span class="speed-dial-label"
                  x-text="activeTab === 'places' ? 'Add Place' : activeTab === 'friends' ? 'Add Friend' : activeTab === 'plans' ? 'Quick Plan' : 'Add'"></span>
          </button>
        </div>
        <!-- Trigger -->
        <button class="speed-dial-trigger" :class="{ open: speedDialOpen }"
                @click="speedDialOpen = !speedDialOpen" aria-label="Menu">
          <span class="speed-dial-icon">
            <svg x-show="activeTab === 'plans'" class="roulette-icon roulette-icon-lg" viewBox="0 0 24 24" width="28" height="28" fill="currentColor"><circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.5"/><circle cx="12" cy="12" r="7" fill="none" stroke="currentColor" stroke-width="1"/><circle cx="12" cy="12" r="1.5"/><line x1="12" y1="2" x2="12" y2="5" stroke="currentColor" stroke-width="1.5"/><line x1="12" y1="5" x2="12" y2="12" stroke="currentColor" stroke-width="0.75"/><line x1="12" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="0.75"/><line x1="12" y1="12" x2="7" y2="18" stroke="currentColor" stroke-width="0.75"/><line x1="12" y1="12" x2="7" y2="6" stroke="currentColor" stroke-width="0.75"/></svg>
            <span x-show="activeTab !== 'plans'" style="font-size:1.5rem">+</span>
          </span>
          <span class="speed-dial-unread" x-show="unreadChatCount > 0 && !speedDialOpen"></span>
        </button>
      </div>

      <!-- Tab Content -->
      <div x-show="loggedIn" class="tab-content"
           @touchstart="handleTabSwipeStart($event); handlePullStart($event)"
           @touchmove="handlePullMove($event)"
           @touchend="handleTabSwipeEnd($event); handlePullEnd()">
        <!-- Pull-to-refresh indicator -->
        <div class="pull-indicator" :style="{ transform: 'translateY(' + (pullDistance - 40) + 'px)', opacity: pullDistance / 50 }">
          <span :class="{ 'pull-spinner': refreshing }" x-text="refreshing ? '‚Üª' : '‚Üì'"></span>
        </div>

        <!-- ‚ïê‚ïê‚ïê PLACES TAB ‚ïê‚ïê‚ïê -->
        <section x-show="activeTab === 'places'" x-transition:enter="tab-transition-enter" x-transition:enter-start="tab-transition-enter-from" x-transition:enter-end="tab-transition-enter-to">
          <!-- Search Area -->
          <div class="search-area">
            <div class="autocomplete-container">
              <input id="place-search" x-ref="placeSearch" placeholder="Search for a place..." autocomplete="off"
                     x-model="placeSearch" @input.debounce.300ms="searchPlaces()"
                     @keydown.escape="predictions = []; highlightedIndex = -1"
                     @keydown.arrow-down.prevent="handlePlaceKeydown($event)"
                     @keydown.arrow-up.prevent="handlePlaceKeydown($event)"
                     @keydown.enter.prevent="handlePlaceKeydown($event)"
                     aria-label="Search for a restaurant"
                     role="combobox" aria-expanded="false" :aria-expanded="predictions.length > 0"
                     :aria-activedescendant="highlightedIndex >= 0 ? 'place-opt-' + highlightedIndex : null" />
              <span class="spinner" x-show="searching"></span>
              <ul class="autocomplete-list" x-show="predictions.length > 0" role="listbox">
                <template x-for="(pred, index) in predictions" :key="pred.place_id">
                  <li @click="selectPlace(pred)" x-text="pred.description" role="option" tabindex="0"
                      @keydown.enter="selectPlace(pred)"
                      :id="'place-opt-' + index"
                      :class="{ 'highlighted': index === highlightedIndex }"></li>
                </template>
              </ul>
              <p class="no-results" x-show="predictions.length === 0 && placeSearch.length > 2 && searchedOnce">
                No results found. Try a different search term.
              </p>
            </div>
            <div x-show="selectedPlace" x-transition class="search-actions">
              <span class="selected-place-name" x-text="selectedPlace?.name"></span>
              <div class="search-action-btns">
                <button class="action-like" @click="likePlace()" aria-label="Like this place">üëç</button>
                <button class="action-dislike" @click="dislikePlace()" aria-label="Dislike this place">üëé</button>
                <button class="action-wtt" @click="wantToTryPlace()" aria-label="Add to want to try list">üìå</button>
              </div>
            </div>
          </div>

          <!-- Filter Toggle (mobile only) -->
          <div class="filter-toggle-wrapper"
               x-show="likes.length > 3 || dislikes.length > 3 || wantToTry.length > 3">
            <button class="filter-toggle-btn" @click="filtersOpen = !filtersOpen">
              <span x-text="filtersOpen ? 'Hide Filters' : 'Show Filters'"></span>
              <span class="filter-active-badge"
                    x-show="placeTypeFilter || placeSortBy !== 'name' || placeMealTypeFilter"
                    x-text="[placeTypeFilter, placeSortBy !== 'name', placeMealTypeFilter].filter(Boolean).length"></span>
            </button>
          </div>
          <!-- Filter & Sort -->
          <div x-show="likes.length > 3 || dislikes.length > 3 || wantToTry.length > 3"
               class="filter-controls filter-collapsible" :class="{ 'filter-open': filtersOpen }">
            <input placeholder="Filter places..." x-model="placeFilter" aria-label="Filter your places" />
            <select class="filter-select" x-model="placeTypeFilter" aria-label="Filter by type">
              <option value="">All Types</option>
              <template x-for="t in uniqueRestaurantTypes" :key="t">
                <option :value="t" x-text="t"></option>
              </template>
            </select>
            <select class="filter-select" x-model="placeSortBy" aria-label="Sort by">
              <option value="name">Sort: Name</option>
              <option value="type">Sort: Type</option>
            </select>
          </div>
          <!-- Meal Type Filter -->
          <div x-show="likes.length > 0 || wantToTry.length > 0"
               class="meal-type-filter-chips filter-collapsible" :class="{ 'filter-open': filtersOpen }">
            <button class="filter-chip" :class="{ active: placeMealTypeFilter === '' }"
                    @click="placeMealTypeFilter = ''">All Meals</button>
            <template x-for="mt in MEAL_TYPES" :key="mt">
              <button class="filter-chip" :class="{ active: placeMealTypeFilter === mt }"
                      @click="placeMealTypeFilter = mt" x-text="mt"></button>
            </template>
          </div>

          <!-- Explore Nearby -->
          <div class="nearby-section">
            <button class="account-btn" @click="exploreNearby()" :disabled="nearbyLoading">
              <span x-show="!nearbyLoading">Explore Nearby</span>
              <span x-show="nearbyLoading">Searching...</span>
            </button>
            <div x-show="nearbyError" class="warning-text" x-text="nearbyError"></div>
            <div x-show="nearbyPlaces.length > 0" class="nearby-grid">
              <template x-for="place in nearbyPlaces" :key="place.place_id">
                <div class="nearby-card">
                  <div class="nearby-card-info">
                    <strong x-text="place.name"></strong>
                    <span class="type-badge" x-show="place.types && place.types[0]" x-text="place.types[0]"></span>
                    <span x-show="place.rating" class="nearby-rating" x-text="'‚òÖ ' + place.rating"></span>
                  </div>
                  <div class="nearby-card-address" x-text="place.address"></div>
                  <div class="nearby-card-actions">
                    <button class="suggest-btn" @click="addNearbyToList(place, 'like')">Like</button>
                    <button class="back-btn" @click="addNearbyToList(place, 'want_to_try')">Want to Try</button>
                    <button class="remove-btn" @click="addNearbyToList(place, 'dislike')">Dislike</button>
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- Quick Pick -->
          <div x-show="likes.length > 0" class="quick-pick-section">
            <div class="quick-pick-row">
              <button class="quick-pick-btn" @click="quickPick()" :disabled="quickPicking || moodPicking">
                üé≤ Any
              </button>
              <template x-for="t in moodPickTypes" :key="t">
                <button class="mood-chip" @click="moodPick(t)" :disabled="moodPicking || quickPicking"
                        :class="{ active: moodPickType === t }" x-text="t"></button>
              </template>
              <button class="mood-chip surprise" @click="moodSurpriseMe()" :disabled="moodPicking || quickPicking">
                Surprise Me!
              </button>
            </div>
            <label class="mood-toggle" x-show="wantToTry.length > 0">
              <input type="checkbox" x-model="moodIncludeWantToTry" />
              Include Want to Try
            </label>
            <div x-show="quickPickResult && !moodPickResult" class="quick-pick-result">
              <span x-text="quickPickResult?.name"></span>
              <span class="type-badge" x-show="quickPickResult?.restaurant_type" x-text="quickPickResult?.restaurant_type"></span>
              <a :href="quickPickMapUrl" target="_blank" rel="noopener">View on Map</a>
            </div>
            <div x-show="moodPickResult" class="quick-pick-result" x-transition.scale.origin.top>
              <strong x-text="moodPickResult?.name"></strong>
              <span class="type-badge" x-show="moodPickResult?.restaurant_type" x-text="moodPickResult?.restaurant_type"></span>
              <span class="mood-result-address" x-show="moodPickResult?.address" x-text="moodPickResult?.address"></span>
              <div class="mood-result-actions">
                <a class="mood-go-btn" :href="moodPickMapUrl" target="_blank" rel="noopener">View on Map</a>
                <button class="mood-reroll-btn" @click="moodPick(moodPickType)" :disabled="moodPicking">Pick Again</button>
                <button class="mood-dismiss-btn" @click="clearMoodPick()">Dismiss</button>
              </div>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ Favorites Section ‚îÄ‚îÄ -->
          <div x-show="starredPlaces.length > 0">
            <div class="section-header" @click="togglePlaceSection('favorites')">
              <h3>
                <span class="section-collapse-icon" :class="{ open: placeSections.favorites }">&#x25B6;</span>
                &#x2605; Favorites
                <span class="section-count" x-text="starredPlaces.length"></span>
              </h3>
            </div>
            <div x-show="placeSections.favorites" x-collapse>
              <div class="place-card-grid">
                <template x-for="place in starredPlaces" :key="'fav-' + place.name">
                  <div class="place-card"
                       @touchstart="onTouchStart($event, place.name)"
                       @touchmove="onTouchMove($event, place.name)"
                       @touchend="onTouchEnd(place._type, place)"
                       :style="{ transform: getSwipeTransform(place.name), background: getSwipeBg(place.name) || undefined, transition: swipeState.swiping ? 'none' : 'transform 0.2s' }">
                    <img x-show="place.photo_ref" :src="placePhotoUrl(place.photo_ref)" class="place-card-photo" loading="lazy" alt="" />
                    <div class="place-card-header">
                      <div class="place-card-name-block">
                        <strong x-text="displayName(place)"></strong>
                        <span class="place-card-address" x-show="displayAddress(place)" x-text="displayAddress(place)"></span>
                      </div>
                      <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                    </div>
                    <div class="place-card-note" x-show="editingNote !== place.name && place.notes">
                      <span class="note-text" @click="startEditNote(place)" x-text="place.notes"></span>
                    </div>
                    <div class="place-note-edit" x-show="editingNote === place.name">
                      <input type="text" x-model="noteText" placeholder="Add a note..."
                             @keydown.enter="saveNote(place)" @keydown.escape="cancelEditNote()" />
                      <button class="suggest-btn" @click="saveNote(place)" aria-label="Save note">‚úì Save</button>
                      <button class="back-btn" @click="cancelEditNote()" aria-label="Cancel">‚úï Cancel</button>
                    </div>
                    <div class="place-card-actions">
                      <button class="star-btn starred" @click="toggleStar(place._type, place.name)"
                              aria-label="Unstar">&#x2605;</button>
                      <a class="reviews-link" x-show="place.place_id" :href="googleReviewsUrl(place.name, place.place_id)"
                         target="_blank" rel="noopener" aria-label="View Google reviews">‚òÖ Reviews</a>
                      <button class="map-btn" @click="openMap(place.name)" aria-label="View on map"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z"/></svg> Map</button>
                      <button class="overflow-toggle" @click.stop="cardMenuOpen = cardMenuOpen === 'fav-'+place.name ? null : 'fav-'+place.name" aria-label="More actions">¬∑¬∑¬∑</button>
                    </div>
                    <div class="card-overflow-menu" x-show="cardMenuOpen === 'fav-'+place.name" @click.outside="cardMenuOpen = null" x-collapse>
                      <button class="remove-btn" @click="removePlace(place._type, place.name); cardMenuOpen = null" :aria-label="'Remove from ' + place._type">‚úï Remove</button>
                      <button class="note-add-btn" x-show="!place.notes && editingNote !== place.name"
                              @click="startEditNote(place); cardMenuOpen = null" aria-label="Add note">üìù Note</button>
                      <button class="move-btn" x-show="place._type === 'want_to_try'" @click="movePlace('want_to_try', 'likes', place); cardMenuOpen = null" aria-label="Move to likes">üëç Like</button>
                      <div class="card-overflow-divider"></div>
                      <div class="card-overflow-label">Meal Types</div>
                      <div class="meal-type-pills">
                        <template x-for="mt in MEAL_TYPES" :key="mt">
                          <button class="meal-pill" :class="{ active: hasMealType(place, mt) }"
                                  @click="toggleMealType(place._type, place, mt)" x-text="mt"></button>
                        </template>
                      </div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ Liked Section ‚îÄ‚îÄ -->
          <div class="section-header" @click="togglePlaceSection('likes')">
            <h3>
              <span class="section-collapse-icon" :class="{ open: placeSections.likes }">&#x25B6;</span>
              Liked
              <span class="section-count" x-text="likes.filter(p => !p.starred).length"></span>
            </h3>
          </div>
          <div x-show="placeSections.likes" x-collapse>
            <!-- Skeleton Loading -->
            <div x-show="loading.places" class="skeleton-list">
              <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
              <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
              <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
            </div>
            <div class="place-card-grid" x-show="!loading.places">
              <template x-for="place in filteredLikes" :key="place.name">
                <div class="place-card"
                     @touchstart="onTouchStart($event, place.name)"
                     @touchmove="onTouchMove($event, place.name)"
                     @touchend="onTouchEnd('likes', place)"
                     :style="{ transform: getSwipeTransform(place.name), background: getSwipeBg(place.name) || undefined, transition: swipeState.swiping ? 'none' : 'transform 0.2s' }">
                  <img x-show="place.photo_ref" :src="placePhotoUrl(place.photo_ref)" class="place-card-photo" loading="lazy" alt="" />
                  <div class="place-card-header">
                    <div class="place-card-name-block">
                      <strong x-text="displayName(place)"></strong>
                      <span class="place-card-address" x-show="displayAddress(place)" x-text="displayAddress(place)"></span>
                    </div>
                    <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                  </div>
                  <div class="place-card-note" x-show="editingNote !== place.name && place.notes">
                    <span class="note-text" @click="startEditNote(place)" x-text="place.notes"></span>
                  </div>
                  <div class="place-note-edit" x-show="editingNote === place.name">
                    <input type="text" x-model="noteText" placeholder="Add a note..."
                           @keydown.enter="saveNote(place)" @keydown.escape="cancelEditNote()" />
                    <button class="suggest-btn" @click="saveNote(place)" aria-label="Save note">‚úì Save</button>
                    <button class="back-btn" @click="cancelEditNote()" aria-label="Cancel">‚úï Cancel</button>
                  </div>
                  <div class="place-card-actions">
                    <button class="star-btn" @click="toggleStar('likes', place.name)"
                            :aria-label="place.starred ? 'Unstar ' + place.name : 'Star ' + place.name"
                            x-text="place.starred ? '\u2605' : '\u2606'"></button>
                    <a class="reviews-link" x-show="place.place_id" :href="googleReviewsUrl(place.name, place.place_id)"
                       target="_blank" rel="noopener" aria-label="View Google reviews">‚òÖ Reviews</a>
                    <button class="map-btn" @click="openMap(place.name)" aria-label="View on map"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z"/></svg> Map</button>
                    <button class="overflow-toggle" @click.stop="cardMenuOpen = cardMenuOpen === 'like-'+place.name ? null : 'like-'+place.name" aria-label="More actions">¬∑¬∑¬∑</button>
                  </div>
                  <div class="card-overflow-menu" x-show="cardMenuOpen === 'like-'+place.name" @click.outside="cardMenuOpen = null" x-collapse>
                    <button class="remove-btn" @click="removePlace('likes', place.name); cardMenuOpen = null" aria-label="Remove from likes">‚úï Remove</button>
                    <button class="note-add-btn" x-show="!place.notes && editingNote !== place.name"
                            @click="startEditNote(place); cardMenuOpen = null" aria-label="Add note">üìù Note</button>
                    <div class="card-overflow-divider"></div>
                    <div class="card-overflow-label">Meal Types</div>
                    <div class="meal-type-pills">
                      <template x-for="mt in MEAL_TYPES" :key="mt">
                        <button class="meal-pill" :class="{ active: hasMealType(place, mt) }"
                                @click="toggleMealType('likes', place, mt)" x-text="mt"></button>
                      </template>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <div x-show="likes.length === 0 && !loading.places" class="empty-state">
              <span class="empty-state-icon">&#x1F37D;</span>
              <p>No liked places yet.</p>
              <p class="empty-state-hint">Search above and tap Like to start building your list.</p>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ Disliked Section ‚îÄ‚îÄ -->
          <div class="section-header" @click="togglePlaceSection('dislikes')">
            <h3>
              <span class="section-collapse-icon" :class="{ open: placeSections.dislikes }">&#x25B6;</span>
              Disliked
              <span class="section-count" x-text="dislikes.length"></span>
            </h3>
          </div>
          <div x-show="placeSections.dislikes" x-collapse>
            <div x-show="loading.places" class="skeleton-list">
              <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
              <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
            </div>
            <div class="place-card-grid" x-show="!loading.places">
              <template x-for="place in filteredDislikes" :key="place.name">
                <div class="place-card"
                     @touchstart="onTouchStart($event, place.name)"
                     @touchmove="onTouchMove($event, place.name)"
                     @touchend="onTouchEnd('dislikes', place)"
                     :style="{ transform: getSwipeTransform(place.name), background: getSwipeBg(place.name) || undefined, transition: swipeState.swiping ? 'none' : 'transform 0.2s' }">
                  <div class="place-card-header">
                    <div class="place-card-name-block">
                      <strong x-text="displayName(place)"></strong>
                      <span class="place-card-address" x-show="displayAddress(place)" x-text="displayAddress(place)"></span>
                    </div>
                    <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                  </div>
                  <div class="place-card-actions">
                    <button class="remove-btn" @click="removePlace('dislikes', place.name)" aria-label="Remove from dislikes">‚úï Remove</button>
                    <button class="map-btn" @click="openMap(place.name)" aria-label="View on map"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z"/></svg> Map</button>
                    <button class="overflow-toggle" @click.stop="cardMenuOpen = cardMenuOpen === 'dis-'+place.name ? null : 'dis-'+place.name" aria-label="More actions">¬∑¬∑¬∑</button>
                  </div>
                  <div class="card-overflow-menu" x-show="cardMenuOpen === 'dis-'+place.name" @click.outside="cardMenuOpen = null" x-collapse>
                    <a class="reviews-link" x-show="place.place_id" :href="googleReviewsUrl(place.name, place.place_id)"
                       target="_blank" rel="noopener" aria-label="View Google reviews">‚òÖ Reviews</a>
                    <button class="move-btn" @click="movePlace('dislikes', 'likes', place); cardMenuOpen = null" aria-label="Move to likes">üëç Move to Likes</button>
                    <button class="move-btn" @click="movePlace('dislikes', 'want_to_try', place); cardMenuOpen = null" aria-label="Move to want to try">üìå Want to Try</button>
                  </div>
                </div>
              </template>
            </div>
            <div x-show="dislikes.length === 0 && !loading.places" class="empty-state">
              <span class="empty-state-icon">&#x1F44E;</span>
              <p>No disliked places yet.</p>
              <p class="empty-state-hint">Places you dislike will appear here.</p>
            </div>
          </div>

          <!-- ‚îÄ‚îÄ Want to Try Section ‚îÄ‚îÄ -->
          <div class="section-header" @click="togglePlaceSection('wantToTry')">
            <h3>
              <span class="section-collapse-icon" :class="{ open: placeSections.wantToTry }">&#x25B6;</span>
              Want to Try
              <span class="section-count" x-text="wantToTry.filter(p => !p.starred).length"></span>
            </h3>
          </div>
          <div x-show="placeSections.wantToTry" x-collapse>
            <div x-show="loading.places" class="skeleton-list">
              <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
              <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
            </div>
            <div class="place-card-grid" x-show="!loading.places">
              <template x-for="place in filteredWantToTry" :key="place.name">
                <div class="place-card"
                     @touchstart="onTouchStart($event, place.name)"
                     @touchmove="onTouchMove($event, place.name)"
                     @touchend="onTouchEnd('want_to_try', place)"
                     :style="{ transform: getSwipeTransform(place.name), background: getSwipeBg(place.name) || undefined, transition: swipeState.swiping ? 'none' : 'transform 0.2s' }">
                  <img x-show="place.photo_ref" :src="placePhotoUrl(place.photo_ref)" class="place-card-photo" loading="lazy" alt="" />
                  <div class="place-card-header">
                    <div class="place-card-name-block">
                      <strong x-text="displayName(place)"></strong>
                      <span class="place-card-address" x-show="displayAddress(place)" x-text="displayAddress(place)"></span>
                    </div>
                    <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                  </div>
                  <div class="place-card-actions">
                    <button class="star-btn" @click="toggleStar('want_to_try', place.name)"
                            :aria-label="place.starred ? 'Unstar ' + place.name : 'Star ' + place.name"
                            x-text="place.starred ? '\u2605' : '\u2606'"></button>
                    <a class="reviews-link" x-show="place.place_id" :href="googleReviewsUrl(place.name, place.place_id)"
                       target="_blank" rel="noopener" aria-label="View Google reviews">‚òÖ Reviews</a>
                    <button class="map-btn" @click="openMap(place.name)" aria-label="View on map"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z"/></svg> Map</button>
                    <button class="overflow-toggle" @click.stop="cardMenuOpen = cardMenuOpen === 'wtt-'+place.name ? null : 'wtt-'+place.name" aria-label="More actions">¬∑¬∑¬∑</button>
                  </div>
                  <div class="card-overflow-menu" x-show="cardMenuOpen === 'wtt-'+place.name" @click.outside="cardMenuOpen = null" x-collapse>
                    <button class="remove-btn" @click="removePlace('want_to_try', place.name); cardMenuOpen = null" aria-label="Remove from want to try">‚úï Remove</button>
                    <button class="move-btn" @click="movePlace('want_to_try', 'likes', place); cardMenuOpen = null" aria-label="Move to likes">üëç Move to Likes</button>
                    <div class="card-overflow-divider"></div>
                    <div class="card-overflow-label">Meal Types</div>
                    <div class="meal-type-pills">
                      <template x-for="mt in MEAL_TYPES" :key="mt">
                        <button class="meal-pill" :class="{ active: hasMealType(place, mt) }"
                                @click="toggleMealType('want_to_try', place, mt)" x-text="mt"></button>
                      </template>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            <div x-show="wantToTry.length === 0 && !loading.places" class="empty-state">
              <span class="empty-state-icon">‚≠ê</span>
              <p>No places on your bucket list yet.</p>
              <p class="empty-state-hint">Mark places you want to try!</p>
            </div>
          </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê FRIENDS TAB ‚ïê‚ïê‚ïê -->
        <section x-show="activeTab === 'friends'" x-transition:enter="tab-transition-enter" x-transition:enter-start="tab-transition-enter-from" x-transition:enter-end="tab-transition-enter-to">
          <label for="friend-input">Add a friend</label>
          <div class="inline-input">
            <input id="friend-input" x-ref="friendInput" x-model="friendUsername" placeholder="Friend's username"
                   @keydown.enter="inviteFriend()" aria-label="Friend's username" />
            <button @click="inviteFriend()">Send Request</button>
          </div>

          <!-- Group Presets -->
          <div x-show="friends.length > 0" class="group-presets-section">
            <div class="section-header-inline">
              <h4>Group Presets</h4>
              <button class="suggest-btn" @click="openCreateGroup()">+ New Group</button>
            </div>
            <div x-show="friendGroups.length === 0" class="empty-state-mini">No groups yet</div>
            <template x-for="group in friendGroups" :key="group.id">
              <div class="group-preset-card">
                <div class="group-preset-info">
                  <strong x-text="group.name"></strong>
                  <div class="group-member-chips">
                    <template x-for="m in group.members" :key="m.user_id">
                      <span class="avatar avatar-xxs avatar-inline" :class="{ 'avatar-pic': m.profile_pic }" :style="avatarStyle(m)" :title="m.display_name || m.username" x-text="m.profile_pic ? '' : getInitials(m.display_name || m.username)"></span>
                    </template>
                  </div>
                </div>
                <div class="group-preset-actions">
                  <button class="edit-btn" @click="openEditGroup(group)">Edit</button>
                  <button class="remove-btn" @click="deleteGroup(group.id)">Delete</button>
                </div>
              </div>
            </template>
          </div>

          <!-- Group Modal -->
          <div class="modal-overlay" x-show="groupModal.visible" x-transition.opacity @click.self="groupModal.visible = false">
            <div class="modal-content">
              <h4 x-text="groupModal.editingId ? 'Edit Group' : 'Create Group'"></h4>
              <input type="text" x-model="groupModal.name" placeholder="Group name" aria-label="Group name" />
              <p style="font-size: var(--text-sm); color: var(--text-secondary); margin: 0.5rem 0 0.3rem;">Select members:</p>
              <div class="group-member-select">
                <template x-for="f in friends" :key="f.id">
                  <label class="group-member-option" @click="toggleGroupMember(f.id)">
                    <input type="checkbox" :checked="groupModal.selectedMembers.includes(f.id)" />
                    <span class="avatar avatar-xs avatar-inline" :class="{ 'avatar-pic': f.profile_pic }" :style="avatarStyle(f)" x-text="f.profile_pic ? '' : getInitials(f.display_name || f.username)"></span>
                    <span x-text="f.display_name || f.username"></span>
                  </label>
                </template>
              </div>
              <div class="modal-actions">
                <button class="suggest-btn" @click="saveGroup()">Save</button>
                <button class="back-btn" @click="groupModal.visible = false">Cancel</button>
              </div>
            </div>
          </div>

          <!-- Pending Friend Requests -->
          <div x-show="friendRequests.length > 0" class="friends-list">
            <h4>Friend Requests</h4>
            <ul>
              <template x-for="r in friendRequests" :key="r.id">
                <li>
                  <span class="avatar avatar-sm avatar-inline" :class="{ 'avatar-pic': r.profile_pic }" :style="avatarStyle(r)" x-text="r.profile_pic ? '' : getInitials(r.display_name || r.username)"></span>
                  <span x-text="r.display_name || r.username"></span>
                  <span class="username-secondary" x-show="r.display_name" x-text="'@' + r.username"></span>
                  <span class="place-actions">
                    <button class="suggest-btn" @click="acceptFriend(r.id)" aria-label="Accept">‚úì</button>
                    <button class="remove-btn" @click="rejectFriend(r.id)" aria-label="Reject">‚úï</button>
                  </span>
                </li>
              </template>
            </ul>
          </div>

          <!-- Friends List -->
          <div class="friends-list">
            <h4>Friends</h4>
            <!-- Skeleton Loading -->
            <div x-show="loading.friends" class="skeleton-list">
              <div class="skeleton-card skeleton-row"><div class="skeleton-avatar"></div><div class="skeleton-line skeleton-line-md"></div></div>
              <div class="skeleton-card skeleton-row"><div class="skeleton-avatar"></div><div class="skeleton-line skeleton-line-md"></div></div>
              <div class="skeleton-card skeleton-row"><div class="skeleton-avatar"></div><div class="skeleton-line skeleton-line-md"></div></div>
            </div>
            <template x-if="friends.length > 0 && !loading.friends">
              <ul>
                <template x-for="f in friends" :key="f.id">
                  <li class="friend-item">
                    <div class="friend-header">
                      <span class="avatar avatar-sm avatar-inline" :class="{ 'avatar-pic': f.profile_pic }" :style="avatarStyle(f)" x-text="f.profile_pic ? '' : getInitials(f.display_name || f.username)"></span>
                      <span x-text="f.display_name || f.username"></span>
                      <span class="place-actions">
                        <button class="suggest-btn" x-show="activePlan && activePlan.plan.status === 'open'"
                                @click="quickInviteFriend(f.username)"
                                :disabled="activePlan?.members?.some(m => m.username === f.username)"
                                :title="activePlan?.members?.some(m => m.username === f.username) ? 'Already in plan' : 'Invite to plan'"
                                aria-label="Invite to plan"
                                x-text="activePlan?.members?.some(m => m.username === f.username) ? 'In Plan' : 'Invite'"></button>
                        <button class="remove-btn" @click="removeFriend(f.id)" aria-label="Remove friend">‚úï</button>
                      </span>
                    </div>

                    <!-- Liked Places (collapsible) -->
                    <div class="friend-section-toggle" @click="toggleFriendLikes(f.id)">
                      <span class="section-collapse-icon" :class="{ open: getFriendSection(f.id).likesOpen }">&#x25B6;</span>
                      Liked Places
                      <span class="section-count" x-show="getFriendSection(f.id).likes"
                            x-text="getFriendSection(f.id).likes?.length || 0"></span>
                    </div>
                    <div x-show="getFriendSection(f.id).likesOpen" x-collapse>
                      <ul class="place-list friend-inline-list">
                        <template x-for="(place, idx) in getFriendSection(f.id).likes || []" :key="'fl-' + idx">
                          <li>
                            <div class="place-info">
                              <span x-text="place.name"></span>
                              <span class="type-badge" x-show="place.restaurant_type" x-text="place.restaurant_type"></span>
                            </div>
                            <span class="place-actions friend-place-actions">
                              <button class="friend-action-btn friend-fav-btn"
                                      @click="addFriendPlace(place, 'favorite')"
                                      :disabled="likes.some(l => l.name === place.name) || dislikes.some(d => d.name === place.name)"
                                      :title="likes.some(l => l.name === place.name) ? 'Already in your likes' : dislikes.some(d => d.name === place.name) ? 'Already disliked' : 'Add to Favorites'">&#x2605;</button>
                              <button class="friend-action-btn friend-like-btn"
                                      @click="addFriendPlace(place, 'like')"
                                      :disabled="likes.some(l => l.name === place.name) || dislikes.some(d => d.name === place.name)"
                                      :title="likes.some(l => l.name === place.name) ? 'Already liked' : dislikes.some(d => d.name === place.name) ? 'Already disliked' : 'Add to Likes'">&#x1F44D;</button>
                              <button class="friend-action-btn friend-dislike-btn"
                                      @click="addFriendPlace(place, 'dislike')"
                                      :disabled="likes.some(l => l.name === place.name) || dislikes.some(d => d.name === place.name)"
                                      :title="likes.some(l => l.name === place.name) ? 'Already liked' : dislikes.some(d => d.name === place.name) ? 'Already disliked' : 'Add to Dislikes'">&#x1F44E;</button>
                              <button class="map-btn" @click="openMap(place.name)" aria-label="View on map"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z"/></svg></button>
                            </span>
                          </li>
                        </template>
                      </ul>
                      <div x-show="getFriendSection(f.id).likes?.length === 0" class="empty-state">
                        <p>No liked places yet.</p>
                      </div>
                    </div>

                    <!-- Common Places (collapsible) -->
                    <div class="friend-section-toggle" @click="toggleFriendCommon(f.id, f.username)">
                      <span class="section-collapse-icon" :class="{ open: getFriendSection(f.id).commonOpen }">&#x25B6;</span>
                      Common Places
                      <span class="section-count" x-show="getFriendSection(f.id).commonPlaces"
                            x-text="getFriendSection(f.id).commonPlaces?.length || 0"></span>
                    </div>
                    <div x-show="getFriendSection(f.id).commonOpen" x-collapse>
                      <ul class="place-list friend-inline-list">
                        <template x-for="(place, idx) in getFriendSection(f.id).commonPlaces || []" :key="'fc-' + idx">
                          <li>
                            <span x-text="place"></span>
                            <button class="map-btn" @click="openMap(place)" aria-label="View on map"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z"/></svg></button>
                          </li>
                        </template>
                      </ul>
                      <div x-show="getFriendSection(f.id).commonPlaces?.length === 0" class="empty-state">
                        <p>No common places yet.</p>
                      </div>
                    </div>
                  </li>
                </template>
              </ul>
            </template>
            <div x-show="friends.length === 0 && !loading.friends" class="empty-state">
              <span class="empty-state-icon">&#x1F465;</span>
              <p>No friends yet.</p>
              <p class="empty-state-hint">Enter a username above and send a friend request.</p>
            </div>
          </div>

          <!-- Leaderboard -->
          <div x-show="friends.length > 0" class="leaderboard-section">
            <div class="section-header-inline">
              <h4>Leaderboard</h4>
              <button class="suggest-btn" @click="loadLeaderboard()" x-show="leaderboard.length === 0">Load</button>
            </div>
            <div x-show="leaderboard.length > 0">
              <div class="leaderboard-metrics">
                <button class="filter-chip" :class="{ active: leaderboardMetric === 'plans' }" @click="switchLeaderboardMetric('plans')">Plans</button>
                <button class="filter-chip" :class="{ active: leaderboardMetric === 'winRate' }" @click="switchLeaderboardMetric('winRate')">Win Rate</button>
                <button class="filter-chip" :class="{ active: leaderboardMetric === 'restaurantsVisited' }" @click="switchLeaderboardMetric('restaurantsVisited')">Visited</button>
              </div>
              <div class="leaderboard-list">
                <template x-for="(entry, idx) in leaderboard" :key="entry.id">
                  <div class="leaderboard-row" :class="{ 'leaderboard-self': entry.is_self }">
                    <span class="leaderboard-rank" x-text="idx + 1"></span>
                    <span class="avatar avatar-xs" :class="{ 'avatar-pic': entry.profile_pic }" :style="avatarStyle(entry)" x-text="entry.profile_pic ? '' : getInitials(entry.display_name || entry.username)"></span>
                    <span class="leaderboard-name" x-text="entry.display_name || entry.username"></span>
                    <span class="leaderboard-score" x-text="leaderboardMetric === 'winRate' ? entry[leaderboardMetric] + '%' : entry[leaderboardMetric]"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Activity Feed -->
          <div x-show="friends.length > 0" class="activity-feed-section">
            <div class="section-header-inline">
              <h4>Friend Activity</h4>
              <button class="suggest-btn" @click="loadActivityFeed()" x-show="activityFeed.length === 0">Load</button>
            </div>
            <div x-show="activityFeed.length > 0" class="activity-feed">
              <template x-for="(item, idx) in activityFeed" :key="idx">
                <div class="activity-item">
                  <span class="avatar avatar-xxs" :class="{ 'avatar-pic': item.profile_pic }" :style="avatarStyle(item)" x-text="item.profile_pic ? '' : getInitials(item.display_name || item.username)"></span>
                  <div class="activity-content">
                    <span class="activity-text" x-text="activityText(item)"></span>
                    <span class="activity-time" x-text="activityTime(item)"></span>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê PLANS TAB ‚ïê‚ïê‚ïê -->
        <section x-show="activeTab === 'plans'" x-transition:enter="tab-transition-enter" x-transition:enter-start="tab-transition-enter-from" x-transition:enter-end="tab-transition-enter-to">
          <!-- Plan Management -->
          <div class="plan-subsection">
            <h3>Dinner Plans</h3>
            <div x-show="!activePlan">
              <!-- Active Plans -->
              <h4 x-show="activePlans.length > 0">Active Plans</h4>
              <ul class="plan-list">
                <template x-for="(s, pIdx) in activePlans" :key="s.id">
                  <li @click="openPlan(s.id)" class="stagger-item" :style="{ animationDelay: (pIdx * 40) + 'ms' }">
                    <div>
                      <strong x-text="s.name"></strong>
                      <span class="plan-code" x-text="s.code"></span>
                      <span class="type-badge" x-show="s.meal_type" x-text="s.meal_type"></span>
                      <span class="plan-creator">
                        <span class="avatar avatar-xs avatar-inline" :class="{ 'avatar-pic': s.creator_profile_pic }" :style="avatarStyle({ username: s.creator_username, profile_pic: s.creator_profile_pic, display_name: s.creator_display_name })" x-text="s.creator_profile_pic ? '' : getInitials(s.creator_display_name || s.creator_username)"></span>
                        <span x-text="s.creator_display_name || s.creator_username"></span>
                      </span>
                    </div>
                    <div>
                      <span class="member-count" x-text="s.member_count + ' members'"></span>
                      <span class="plan-status open">open</span>
                    </div>
                  </li>
                </template>
              </ul>

              <div class="plan-action-buttons">
                <button class="add-suggestion-btn" @click="showCreatePlanForm = !showCreatePlanForm"
                        :class="{ active: showCreatePlanForm }" x-show="!showCreatePlanForm">
                  <span>+ New Plan</span>
                </button>
                <div class="inline-input" style="margin-top: 0.5rem;" x-show="!showCreatePlanForm">
                  <input x-model="joinCode" placeholder="Enter invite code" maxlength="6"
                         style="text-transform: uppercase;" @keydown.enter="joinPlan()" aria-label="Plan invite code" />
                  <button @click="joinPlan()">Join Plan</button>
                </div>
              </div>

              <div x-show="showCreatePlanForm" x-collapse>
                <div class="inline-input">
                  <input x-model="newPlanName" placeholder="Plan name (e.g., Friday Dinner)"
                         @keydown.enter="createPlan()" aria-label="Plan name" x-ref="planNameInput" />
                </div>
                <div class="plan-create-options">
                  <div class="veto-limit-create">
                    <label>Vetoes per person:</label>
                    <input type="number" min="0" max="10" x-model.number="planVetoLimitInput"
                           aria-label="Vetoes per person" />
                  </div>
                  <div class="meal-type-create">
                    <label>Meal type:</label>
                    <select x-model="planMealType" aria-label="Plan meal type">
                      <option value="">Any</option>
                      <template x-for="mt in MEAL_TYPES" :key="mt">
                        <option :value="mt" x-text="mt"></option>
                      </template>
                    </select>
                  </div>
                </div>
                <div class="dietary-tags-create" x-show="planDietaryTags !== undefined">
                  <label>Dietary restrictions:</label>
                  <div class="dietary-chips">
                    <template x-for="tag in dietaryOptions" :key="tag">
                      <button class="filter-chip" :class="{ active: planDietaryTags.includes(tag) }"
                              @click="planDietaryTags.includes(tag) ? planDietaryTags = planDietaryTags.filter(t => t !== tag) : planDietaryTags.push(tag)"
                              x-text="tag" type="button"></button>
                    </template>
                  </div>
                </div>
                <div class="plan-create-actions">
                  <button class="suggest-btn" @click="createPlan()">Create Plan</button>
                  <button class="back-btn" @click="showCreatePlanForm = false; newPlanName = ''">Cancel</button>
                </div>
              </div>

              <!-- Recurring Plans -->
              <div class="section-header" @click="showRecurringForm = !showRecurringForm" x-show="friends.length > 0">
                <h4>
                  <span class="section-collapse-icon" :class="{ open: showRecurringForm || recurringPlans.length > 0 }">&#x25B6;</span>
                  Recurring Plans
                  <span class="section-count" x-text="recurringPlans.length" x-show="recurringPlans.length > 0"></span>
                </h4>
              </div>
              <div x-show="showRecurringForm || recurringPlans.length > 0" x-collapse>
                <!-- Recurring form -->
                <div x-show="showRecurringForm" class="recurring-form">
                  <input type="text" x-model="recurringForm.name" placeholder="Plan name" aria-label="Recurring plan name" />
                  <div class="recurring-form-row">
                    <select x-model="recurringForm.frequency" aria-label="Frequency">
                      <option value="weekly">Weekly</option>
                      <option value="biweekly">Biweekly</option>
                      <option value="monthly">Monthly</option>
                    </select>
                    <label>Vetoes: <input type="number" min="0" max="10" x-model.number="recurringForm.vetoLimit" style="width: 3rem;" /></label>
                  </div>
                  <p style="font-size: var(--text-sm); color: var(--text-secondary); margin: 0.3rem 0;">Members:</p>
                  <div class="group-member-select">
                    <template x-for="f in friends" :key="f.id">
                      <label class="group-member-option" @click="toggleRecurringMember(f.id)">
                        <input type="checkbox" :checked="recurringForm.members.includes(f.id)" />
                        <span class="avatar avatar-xs avatar-inline" :class="{ 'avatar-pic': f.profile_pic }" :style="avatarStyle(f)" x-text="f.profile_pic ? '' : getInitials(f.display_name || f.username)"></span>
                        <span x-text="f.display_name || f.username"></span>
                      </label>
                    </template>
                  </div>
                  <div class="recurring-form-actions">
                    <button class="suggest-btn" @click="createRecurringPlan()">Create</button>
                    <button class="back-btn" @click="showRecurringForm = false">Cancel</button>
                  </div>
                </div>
                <!-- Recurring plan list -->
                <template x-for="rp in recurringPlans" :key="rp.id">
                  <div class="recurring-plan-card">
                    <div class="recurring-plan-info">
                      <strong x-text="rp.name"></strong>
                      <div class="recurring-plan-meta">
                        <span class="frequency-badge" x-text="rp.frequency"></span>
                        <span x-show="rp.paused" class="frequency-badge paused">Paused</span>
                        <span class="recurring-next" x-text="'Next: ' + formatNextOccurrence(rp.next_occurrence)"></span>
                      </div>
                    </div>
                    <div class="recurring-controls">
                      <button class="filter-chip" @click="pauseRecurring(rp.id, !rp.paused)" x-text="rp.paused ? 'Resume' : 'Pause'"></button>
                      <button class="filter-chip" @click="skipRecurring(rp.id)">Skip</button>
                      <button class="remove-btn" @click="deleteRecurring(rp.id)">Delete</button>
                    </div>
                  </div>
                </template>
              </div>

              <!-- Meal Type Filter for Plans -->
              <div x-show="plans.length > 0" class="meal-type-filter-chips">
                <button class="filter-chip" :class="{ active: planMealTypeFilter === '' }"
                        @click="planMealTypeFilter = ''">All Meals</button>
                <template x-for="mt in MEAL_TYPES" :key="mt">
                  <button class="filter-chip" :class="{ active: planMealTypeFilter === mt }"
                          @click="planMealTypeFilter = mt" x-text="mt"></button>
                </template>
              </div>

              <!-- Plan History -->
              <div class="section-header" x-show="historyPlans.length > 0" @click="planHistoryVisible = !planHistoryVisible">
                <h4>
                  <span class="section-collapse-icon" :class="{ open: planHistoryVisible }">&#x25B6;</span>
                  Plan History
                  <span class="section-count" x-text="historyPlans.length"></span>
                </h4>
              </div>
              <div x-show="planHistoryVisible" x-collapse>
                <ul class="plan-list">
                  <template x-for="s in historyPlans" :key="s.id">
                    <li @click="openPlan(s.id)">
                      <div>
                        <strong x-text="s.name"></strong>
                        <span class="plan-creator">
                          <span class="avatar avatar-xs avatar-inline" :class="{ 'avatar-pic': s.creator_profile_pic }" :style="avatarStyle({ username: s.creator_username, profile_pic: s.creator_profile_pic, display_name: s.creator_display_name })" x-text="s.creator_profile_pic ? '' : getInitials(s.creator_display_name || s.creator_username)"></span>
                          <span x-text="s.creator_display_name || s.creator_username"></span>
                        </span>
                        <span class="plan-date" x-text="formatDate(s.picked_at || s.created_at)"></span>
                      </div>
                      <div>
                        <span class="member-count" x-text="s.member_count + ' members'"></span>
                        <span x-show="s.winner_place" class="plan-winner" x-text="'Winner: ' + s.winner_place"></span>
                        <span x-show="s.winner_place" class="mini-reservation-links">
                          <a class="mini-reservation-link opentable" :href="openTableUrl(s.winner_place)" target="_blank" rel="noopener" @click.stop title="OpenTable">OT</a>
                          <a class="mini-reservation-link yelp" :href="yelpUrl(s.winner_place)" target="_blank" rel="noopener" @click.stop title="Yelp">Y</a>
                          <a class="mini-reservation-link google" :href="reservationSearchUrl(s.winner_place)" target="_blank" rel="noopener" @click.stop title="Reservations">R</a>
                          <button class="mini-reservation-link calendar" @click.stop="exportCalendar(s.id)" title="Add to Calendar" aria-label="Add to calendar">Cal</button>
                        </span>
                        <button class="remove-btn" x-show="s.creator_id === userId"
                                @click.stop="deletePlan(s.id)" aria-label="Delete plan">Delete</button>
                      </div>
                    </li>
                  </template>
                </ul>
              </div>

              <!-- Dining Timeline -->
              <div class="section-header" @click="historyVisible = !historyVisible; if (historyVisible && historyTimeline.length === 0) loadHistory()">
                <h4>
                  <span class="section-collapse-icon" :class="{ open: historyVisible }">&#x25B6;</span>
                  Dining Timeline
                </h4>
              </div>
              <div x-show="historyVisible" x-collapse>
                <div class="timeline-filters">
                  <input type="date" x-model="historyFilterFrom" @change="loadHistory()" aria-label="From date" />
                  <input type="date" x-model="historyFilterTo" @change="loadHistory()" aria-label="To date" />
                  <input type="text" x-model="historyFilterMember" @input.debounce.500ms="loadHistory()" placeholder="Filter by member..." aria-label="Filter by member" />
                </div>
                <div x-show="historyLoading" class="loading-spinner">Loading...</div>
                <div x-show="!historyLoading && historyTimeline.length === 0" class="empty-state">
                  <p>No dining history yet.</p>
                </div>
                <div class="timeline" x-show="!historyLoading && historyTimeline.length > 0">
                  <template x-for="entry in historyTimeline" :key="entry.id">
                    <div class="timeline-item" @click="openPlan(entry.id)">
                      <div class="timeline-dot"></div>
                      <div class="timeline-connector"></div>
                      <div class="timeline-card">
                        <span class="timeline-date" x-text="formatTimelineDate(entry.picked_at || entry.created_at)"></span>
                        <span class="timeline-plan-name" x-text="entry.name"></span>
                        <div class="timeline-winner">
                          <strong x-text="entry.winner_place"></strong>
                          <span class="type-badge" x-show="entry.winner_type" x-text="entry.winner_type"></span>
                        </div>
                        <div class="timeline-members">
                          <template x-for="m in entry.members.slice(0, 5)" :key="m.username">
                            <span class="avatar avatar-xxs avatar-inline" :class="{ 'avatar-pic': m.profile_pic }" :style="avatarStyle(m)" :title="m.display_name || m.username" x-text="m.profile_pic ? '' : getInitials(m.display_name || m.username)"></span>
                          </template>
                          <span x-show="entry.members.length > 5" class="timeline-more" x-text="'+' + (entry.members.length - 5)"></span>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>

              <!-- Skeleton Loading -->
              <div x-show="loading.plans" class="skeleton-list">
                <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
                <div class="skeleton-card"><div class="skeleton-line skeleton-line-lg"></div><div class="skeleton-line skeleton-line-sm"></div></div>
              </div>
              <div x-show="plans.length === 0 && !loading.plans" class="empty-state">
                <span class="empty-state-icon">&#x1F46B;</span>
                <p>No plans yet.</p>
                <p class="empty-state-hint">Create a plan or join one with an invite code.</p>
              </div>
            </div>

            <!-- Active Plan View -->
            <div x-show="activePlan">
              <div class="plan-header">
                <button class="back-btn" @click="closeActivePlan()" aria-label="Back">‚Üê</button>
                <h4 x-text="activePlan?.plan?.name"></h4>
                <span class="plan-code clickable" @click="copyCode()" x-text="activePlan?.plan?.code"
                      title="Click to copy"></span>
                <span class="type-badge" x-show="activePlan?.plan?.meal_type && activePlan?.plan?.status !== 'open'"
                      x-text="activePlan?.plan?.meal_type"></span>
                <div class="plan-dietary-tags" x-show="activePlan?.plan?.dietary_tags">
                  <template x-for="tag in (activePlan?.plan?.dietary_tags || '').split(',').filter(t => t)" :key="tag">
                    <span class="dietary-badge" x-text="tag"></span>
                  </template>
                </div>
                <button class="overflow-toggle" @click.stop="planHeaderMenuOpen = !planHeaderMenuOpen" aria-label="Plan options">¬∑¬∑¬∑</button>
              </div>
              <div class="plan-header-overflow" x-show="planHeaderMenuOpen" @click.outside="planHeaderMenuOpen = false" x-collapse>
                <select class="plan-meal-type-select" x-model="activePlan.plan.meal_type"
                        @change="updatePlanMealType()" x-show="activePlan?.plan?.status === 'open'"
                        aria-label="Plan meal type">
                  <option value="">Any meal</option>
                  <template x-for="mt in MEAL_TYPES" :key="mt">
                    <option :value="mt" x-text="mt"></option>
                  </template>
                </select>
                <button class="share-invite-btn" @click="sharePlanInvite(); planHeaderMenuOpen = false"
                        x-show="activePlan?.plan?.status === 'open'" aria-label="Share invite"><svg class="icon" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg> Share Invite</button>
                <button class="share-invite-btn" @click="showQrCode(); planHeaderMenuOpen = false"
                        x-show="activePlan?.plan?.status === 'open'" title="Show QR code" aria-label="Show QR code"><svg class="icon" viewBox="0 0 24 24"><path d="M3 11h2V9H3v2zm0-4h2V3H3v4zm4 4h2V7H7v4zm0-8v2h2V3H7zM3 15h2v-2H3v2zm8-12h2v4h-2V3zm-4 12h2v-2H7v2zM3 19h2v-2H3v2zm4 0h2v-2H7v2zm4-4h2v-2h-2v2zm0 4h2v-2h-2v2zm0-8h2V7h-2v4zm4 8h2v-4h-2v4zm0-12h2V3h-2v4zm0 4h2V7h-2v4zm4 4h2v-4h-2v4zm0 4h2v-2h-2v2zm0-12h2V3h-2v4zm0 4h2V7h-2v4z"/></svg> Show QR Code</button>
                <button class="remove-btn" x-show="activePlan?.plan?.creator_id === userId && activePlan?.plan?.status === 'open' && !closingPlan"
                        @click="closePlan()">Close Plan</button>
                <button class="back-btn" x-show="closingPlan" @click="cancelClose()">Cancel Close</button>
                <button class="remove-btn" x-show="activePlan?.plan?.creator_id === userId && activePlan?.plan?.status === 'closed'"
                        @click="deletePlan(activePlan.plan.id)">Delete Plan</button>
              </div>

              <!-- Members with Avatars -->
              <div class="members-line">
                <strong>Members:</strong>

                <!-- Current user "You" chip -->
                <template x-if="activePlan?.members?.find(m => m.id === userId)">
                  <div class="member-chips" style="margin-bottom: 0.15rem;">
                    <span class="member-chip member-chip-you">
                      <span class="avatar avatar-xs" :class="{ 'avatar-pic': profilePic }" :style="avatarStyle({ username, profile_pic: profilePic, display_name: profileName })" x-text="profilePic ? '' : getInitials(profileName || username)"></span>
                      <span>You</span>
                    </span>
                  </div>
                </template>

                <!-- Friends section -->
                <template x-if="planFriendMembers().length > 0">
                  <div class="member-section">
                    <span class="member-section-label">Friends</span>
                    <div class="member-chips">
                      <template x-for="m in planFriendMembers()" :key="m.id">
                        <span class="member-chip">
                          <span class="avatar avatar-xs" :class="{ 'avatar-pic': m.profile_pic }" :style="avatarStyle(m)" x-text="m.profile_pic ? '' : getInitials(m.display_name || m.username)"></span>
                          <span x-text="m.display_name || m.username"></span>
                        </span>
                      </template>
                    </div>
                  </div>
                </template>

                <!-- Not Friends section -->
                <template x-if="planNonFriendMembers().length > 0">
                  <div class="member-section">
                    <span class="member-section-label">Not Friends</span>
                    <div class="member-chips">
                      <template x-for="m in planNonFriendMembers()" :key="m.id">
                        <span class="member-chip member-chip-nonfriend"
                              :class="{ 'member-chip-pending': hasSentRequestTo(m.id) || hasIncomingRequestFrom(m.id) }"
                              @click="!hasSentRequestTo(m.id) && !hasIncomingRequestFrom(m.id) && sendFriendRequestToMember(m.username)"
                              :title="hasSentRequestTo(m.id) ? 'Friend request pending' : hasIncomingRequestFrom(m.id) ? 'Check your friend requests!' : 'Click to send friend request'"
                              :role="hasSentRequestTo(m.id) || hasIncomingRequestFrom(m.id) ? undefined : 'button'"
                              :tabindex="hasSentRequestTo(m.id) || hasIncomingRequestFrom(m.id) ? undefined : '0'"
                              @keydown.enter="!hasSentRequestTo(m.id) && !hasIncomingRequestFrom(m.id) && sendFriendRequestToMember(m.username)">
                          <span class="avatar avatar-xs" :class="{ 'avatar-pic': m.profile_pic }" :style="avatarStyle(m)" x-text="m.profile_pic ? '' : getInitials(m.display_name || m.username)"></span>
                          <span x-text="m.display_name || m.username"></span>
                          <template x-if="hasSentRequestTo(m.id) || hasIncomingRequestFrom(m.id)">
                            <svg class="icon-xs" viewBox="0 0 24 24" fill="currentColor"><path d="M6 2v6l4 4-4 4v6h12v-6l-4-4 4-4V2H6zm10 14.5V20H8v-3.5l4-4 4 4zm-4-5l-4-4V4h8v3.5l-4 4z"/></svg>
                          </template>
                          <template x-if="!hasSentRequestTo(m.id) && !hasIncomingRequestFrom(m.id)">
                            <svg class="icon-xs" viewBox="0 0 24 24" fill="currentColor"><path d="M15 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm-9-2V7H4v3H1v2h3v3h2v-3h3v-2H6zm9 4c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                          </template>
                        </span>
                      </template>
                    </div>
                  </div>
                </template>
              </div>

              <div class="inline-input plan-invite-input" x-show="activePlan?.plan?.status === 'open'">
                <input x-model="planInviteUsername" placeholder="Invite by username..."
                       @keydown.enter="inviteToPlan()" aria-label="Invite user to plan" />
                <button @click="inviteToPlan()">Invite</button>
              </div>
              <div class="group-invite-chips" x-show="activePlan?.plan?.status === 'open' && friendGroups.length > 0">
                <span class="group-invite-label">Invite group:</span>
                <template x-for="g in friendGroups" :key="g.id">
                  <button class="filter-chip" @click="inviteGroupToPlan(g.id)" x-text="g.name"></button>
                </template>
              </div>
              <p x-show="activePlan?.plan?.status === 'closed'" class="closed-badge">This plan is closed.</p>

              <!-- Voting Deadline -->
              <div class="deadline-section" x-show="activePlan?.plan?.status === 'open'">
                <template x-if="activePlan?.plan?.voting_deadline">
                  <div class="deadline-display">
                    <span class="deadline-icon">&#x23F0;</span>
                    <span class="deadline-text" :class="{ urgent: deadlineCountdown.includes('s remaining') && !deadlineCountdown.includes('m') }"
                          x-text="deadlineCountdown || 'Deadline set'"></span>
                    <button class="back-btn btn-sm" x-show="activePlan?.plan?.creator_id === userId"
                            @click="removeDeadline()">Remove</button>
                  </div>
                </template>
                <div class="deadline-controls" x-show="!activePlan?.plan?.voting_deadline && activePlan?.plan?.creator_id === userId">
                  <input type="datetime-local" x-model="deadlineInput" aria-label="Set voting deadline" />
                  <button class="suggest-btn btn-sm" @click="setDeadline()" :disabled="!deadlineInput">Set Deadline</button>
                </div>
              </div>

              <!-- Veto Info -->
              <div class="veto-info-section" x-show="activePlan?.plan?.status === 'open' && (activePlan?.plan?.veto_limit ?? 1) > 0">
                <span class="veto-remaining"
                      x-text="(activePlan?.vetoesRemaining ?? activePlan?.plan?.veto_limit ?? 1) + '/' + (activePlan?.plan?.veto_limit ?? 1) + ' vetoes remaining'"></span>
                <div class="veto-controls" x-show="activePlan?.plan?.creator_id === userId">
                  <input type="number" min="0" max="10" x-model.number="planVetoLimitInput"
                         :placeholder="activePlan?.plan?.veto_limit || 1"
                         aria-label="Set veto limit" />
                  <button class="suggest-btn btn-sm" @click="setVetoLimit()">Update</button>
                </div>
              </div>

              <!-- Winner Selection on Close -->
              <div x-show="closingPlan" class="close-winner-panel">
                <h4>Select the winning restaurant:</h4>
                <ul class="close-winner-list">
                  <template x-for="s in activePlan?.suggestions || []" :key="s.id">
                    <li @click="closeWithWinner(s.place)">
                      <span class="suggestion-name" x-text="displayName(s)"></span>
                      <span class="type-badge" x-show="s.restaurant_type" x-text="s.restaurant_type"></span>
                      <span class="vote-count"
                            :class="{ 'vote-count-high': (s.vote_count - (s.downvote_count || 0)) >= 3, 'vote-count-med': (s.vote_count - (s.downvote_count || 0)) === 2, 'vote-count-negative': (s.downvote_count || 0) > s.vote_count }"
                            x-text="'+' + s.vote_count + ' / -' + (s.downvote_count || 0)"></span>
                    </li>
                  </template>
                </ul>
                <button class="back-btn" @click="closeWithoutWinner()" style="margin-top: 0.5rem;">Close without winner</button>
              </div>

              <!-- Suggest to Plan -->
              <div x-show="activePlan?.plan?.status === 'open'">
                <button class="add-suggestion-btn" @click="suggestSectionOpen = !suggestSectionOpen; if (!suggestSectionOpen) { planCuisineFilter = ''; planSuggestionMealFilter = ''; planPriceFilter = []; }"
                        :class="{ active: suggestSectionOpen }">
                  <span x-text="suggestSectionOpen ? '‚úï Close' : '+ Add Suggestion'"></span>
                </button>
                <div x-show="suggestSectionOpen" x-collapse>
                <div class="autocomplete-container">
                  <input placeholder="Search for a restaurant..." autocomplete="off"
                         x-model="planPlaceSearch" @input.debounce.300ms="searchPlanPlaces()"
                         @keydown.escape="planPredictions = []; planHighlightedIndex = -1"
                         @keydown.arrow-down.prevent="handlePlanKeydown($event)"
                         @keydown.arrow-up.prevent="handlePlanKeydown($event)"
                         @keydown.enter.prevent="handlePlanKeydown($event)"
                         aria-label="Search to suggest a restaurant"
                         role="combobox" aria-expanded="false" :aria-expanded="planPredictions.length > 0"
                         :aria-activedescendant="planHighlightedIndex >= 0 ? 'plan-opt-' + planHighlightedIndex : null" />
                  <span class="spinner" x-show="planSearching"></span>
                  <ul class="autocomplete-list" x-show="planPredictions.length > 0" role="listbox">
                    <template x-for="(pred, index) in planPredictions" :key="pred.place_id">
                      <li @click="suggestToPlan(pred.description, pred.place_id, formatPlaceType(pred.types))"
                          role="option" tabindex="0" :id="'plan-opt-' + index"
                          :class="{ 'highlighted': index === planHighlightedIndex }">
                        <span x-text="pred.description"></span>
                        <span class="dislike-warn-badge" x-show="isPlanDisliked(pred.description)">Disliked by member</span>
                      </li>
                    </template>
                  </ul>
                  <p class="no-results" x-show="planPredictions.length === 0 && planPlaceSearch.length > 2 && planSearchedOnce">
                    No results found. Try a different search term.
                  </p>
                </div>

                <!-- Starred Favorites Quick-Suggest -->
                <div x-show="starredPlaces.length > 0" class="starred-suggest-section">
                  <span class="grid-label">Your Favorites:</span>
                  <div class="starred-suggest-grid">
                    <template x-for="place in starredPlaces" :key="place.name">
                      <button class="starred-suggest-btn"
                              :disabled="isAlreadySuggestedToPlan(place.name)"
                              @click="suggestToPlan(place.name, place.place_id, place.restaurant_type)"
                              :aria-label="'Suggest ' + place.name">
                        <span class="starred-icon">&#x2605;</span>
                        <span x-text="displayName(place)"></span>
                      </button>
                    </template>
                  </div>
                </div>

                <!-- Recently Suggested Quick-Add -->
                <div x-show="recentSuggestions.length > 0" class="recent-suggest-section">
                  <span class="grid-label">Recently suggested:</span>
                  <div class="recent-suggest-grid">
                    <template x-for="rs in recentSuggestions" :key="rs.name">
                      <button class="recent-suggest-btn" :disabled="isAlreadySuggestedToPlan(rs.name)"
                              @click="suggestToPlan(rs.name, rs.place_id, rs.restaurant_type)"
                              :aria-label="'Suggest ' + rs.name" x-text="'+ ' + displayName(rs)"></button>
                    </template>
                  </div>
                </div>

                <div x-show="likes.length > 0 || wantToTry.length > 0" class="meal-type-filter-chips compact">
                  <button class="filter-chip" :class="{ active: planLikesMealFilter === '' }"
                          @click="planLikesMealFilter = ''">All</button>
                  <template x-for="mt in MEAL_TYPES" :key="mt">
                    <button class="filter-chip" :class="{ active: planLikesMealFilter === mt }"
                            @click="planLikesMealFilter = mt" x-text="mt"></button>
                  </template>
                </div>

                <div x-show="likes.length > 0" class="liked-suggest-grid">
                  <span class="grid-label">Quick suggest from likes:</span>
                  <template x-for="place in likes.filter(p => !planLikesMealFilter || (p.meal_types || []).includes(planLikesMealFilter))" :key="place.name">
                    <button class="suggest-btn" :disabled="isAlreadySuggestedToPlan(place.name)"
                            @click="suggestToPlan(place.name, place.place_id, place.restaurant_type)"
                            :aria-label="'Suggest ' + place.name">
                      <span x-text="'+ ' + displayName(place)"></span>
                      <span class="dislike-warn-badge" x-show="isPlanDisliked(place.name)">!</span>
                    </button>
                  </template>
                </div>

                <div x-show="wantToTry.length > 0" class="liked-suggest-grid">
                  <span class="grid-label">From your bucket list:</span>
                  <template x-for="place in wantToTry.filter(p => !planLikesMealFilter || (p.meal_types || []).includes(planLikesMealFilter))" :key="place.name">
                    <button class="want-to-try-quick-btn" :disabled="isAlreadySuggestedToPlan(place.name)"
                            @click="suggestToPlan(place.name, place.place_id, place.restaurant_type)"
                            :aria-label="'Suggest ' + place.name">
                      <span x-text="'‚≠ê ' + displayName(place)"></span>
                    </button>
                  </template>
                </div>
                </div>
              </div>

              <!-- Plan Suggestions with Votes -->
              <h4>Suggestions <span class="vote-hint" x-show="activePlan?.suggestions?.length > 0">(click Vote to upvote)</span></h4>

              <!-- Cuisine / Meal / Price Filters (only when adding suggestions) -->
              <div x-show="suggestSectionOpen" x-collapse>
                <div class="cuisine-filter-chips" x-show="uniquePlanCuisines.length > 1">
                  <button class="filter-chip" :class="{ active: planCuisineFilter === '' }"
                          @click="planCuisineFilter = ''">All</button>
                  <template x-for="cuisine in uniquePlanCuisines" :key="cuisine">
                    <button class="filter-chip" :class="{ active: planCuisineFilter === cuisine }"
                            @click="planCuisineFilter = cuisine" x-text="cuisine"></button>
                  </template>
                </div>

                <div class="meal-type-filter-chips" x-show="activePlan?.suggestions?.some(s => s.meal_types?.length > 0)">
                  <button class="filter-chip" :class="{ active: planSuggestionMealFilter === '' }"
                          @click="planSuggestionMealFilter = ''">All Meals</button>
                  <template x-for="mt in MEAL_TYPES" :key="mt">
                    <button class="filter-chip" :class="{ active: planSuggestionMealFilter === mt }"
                            @click="planSuggestionMealFilter = mt" x-text="mt"></button>
                  </template>
                </div>

                <div class="price-filter-chips" x-show="activePlan?.suggestions?.some(s => s.price_level != null)">
                  <template x-for="level in [1, 2, 3, 4]" :key="level">
                    <button class="filter-chip price-chip"
                            :class="{ active: planPriceFilter.includes(level) }"
                            @click="planPriceFilter.includes(level) ? planPriceFilter = planPriceFilter.filter(l => l !== level) : planPriceFilter = [...planPriceFilter, level]"
                            x-text="'$'.repeat(level)"></button>
                  </template>
                </div>

                <div class="sort-controls" x-show="activePlan?.suggestions?.length > 1">
                  <button class="sort-btn" :class="{ active: planSuggestSort === 'votes' }" @click="planSuggestSort = 'votes'">By Votes</button>
                  <button class="sort-btn" :class="{ active: planSuggestSort === 'name' }" @click="planSuggestSort = 'name'">By Name</button>
                  <button class="sort-btn" :class="{ active: planSuggestSort === 'suggester' }" @click="planSuggestSort = 'suggester'">By Suggester</button>
                </div>
              </div>

              <div class="sort-controls" x-show="activePlan?.suggestions?.length > 1 && !suggestSectionOpen">
                <button class="sort-btn" :class="{ active: planSuggestSort === 'votes' }" @click="planSuggestSort = 'votes'">By Votes</button>
                <button class="sort-btn" :class="{ active: planSuggestSort === 'name' }" @click="planSuggestSort = 'name'">By Name</button>
                <button class="sort-btn" :class="{ active: planSuggestSort === 'suggester' }" @click="planSuggestSort = 'suggester'">By Suggester</button>
              </div>

              <!-- List/Map View Toggle -->
              <div class="view-toggle" x-show="activePlan?.suggestions?.some(s => s.lat != null)">
                <button :class="{ active: !mapView }" @click="mapView = false">List</button>
                <button :class="{ active: mapView }" @click="toggleMapView()">Map</button>
              </div>

              <!-- Map View -->
              <div x-show="mapView">
                <div id="plan-map" class="plan-map"></div>
                <div class="map-legend">
                  <template x-for="(s, idx) in (activePlan?.suggestions || []).filter(s => s.lat != null)" :key="s.id">
                    <span class="map-legend-item">
                      <span class="legend-number" x-text="idx + 1"></span>
                      <span x-text="displayName(s)"></span>
                    </span>
                  </template>
                </div>
              </div>

              <!-- List View -->
              <ul class="plan-suggestion-list" x-show="!mapView">
                <template x-for="(s, sIdx) in sortedPlanSuggestions" :key="s.id">
                  <li :class="{ 'suggestion-vetoed': (s.veto_count || 0) > 0, 'list-item-removing': s._removing }"
                      class="stagger-item" :style="{ animationDelay: (sIdx * 40) + 'ms' }">
                    <div class="suggestion-info">
                      <img x-show="s.photo_ref" :src="placePhotoUrl(s.photo_ref)" class="suggestion-photo-inline" loading="lazy" alt="" />
                      <span class="suggestion-name-block">
                        <span class="suggestion-name" x-text="displayName(s)"></span>
                        <span class="suggestion-address" x-show="displayAddress(s)" x-text="displayAddress(s)"></span>
                      </span>
                      <span class="want-to-try-badge" x-show="isWantToTry(s.place)"
                            :title="getWantToTryUsers(s.place).map(u => u.display_name || u.username).join(', ') + ' want' + (getWantToTryUsers(s.place).length === 1 ? 's' : '') + ' to try this'">
                        ‚≠ê
                        <template x-for="u in getWantToTryUsers(s.place).slice(0, 3)" :key="u.user_id">
                          <span class="avatar avatar-xxs avatar-inline" :class="{ 'avatar-pic': u.profile_pic }" :style="avatarStyle(u)" x-text="u.profile_pic ? '' : getInitials(u.display_name || u.username)"></span>
                        </template>
                      </span>
                      <span class="type-badge" x-show="s.restaurant_type" x-text="s.restaurant_type"></span>
                      <span class="price-badge" x-show="s.price_level" x-text="priceDisplay(s.price_level)"></span>
                      <span class="suggestion-by">
                        <span class="avatar avatar-xs avatar-inline" :class="{ 'avatar-pic': s.suggested_by_profile_pic }" :style="avatarStyle({ username: s.suggested_by, profile_pic: s.suggested_by_profile_pic, display_name: s.suggested_by_display_name })" x-text="s.suggested_by_profile_pic ? '' : getInitials(s.suggested_by_display_name || s.suggested_by)"></span>
                        <span x-text="s.suggested_by_display_name || s.suggested_by"></span>
                      </span>
                    </div>
                    <div class="suggestion-actions">
                      <span class="vote-count vote-count-clickable"
                            :class="{ 'vote-count-high': (s.vote_count - (s.downvote_count || 0)) >= 3, 'vote-count-med': (s.vote_count - (s.downvote_count || 0)) === 2, 'vote-count-negative': (s.downvote_count || 0) > s.vote_count }"
                            @click="s._showVoters = !s._showVoters"
                            x-text="'+' + s.vote_count + ' / -' + (s.downvote_count || 0)"
                            :title="'Up: ' + ((s.voters || []).map(v => memberLookup(v)?.display_name || v).join(', ') || 'none') + ' | Down: ' + ((s.downvoters || []).map(v => memberLookup(v)?.display_name || v).join(', ') || 'none')"
                            :aria-label="'Show voters for ' + s.place"></span>
                      <button class="vote-btn" :class="{ voted: s.user_voted }"
                              @click="toggleVote(s)"
                              :aria-label="s.user_voted ? 'Remove vote' : 'Vote for ' + s.place"
                              x-show="activePlan?.plan?.status === 'open' && (s.veto_count || 0) === 0">üëç</button>
                      <button class="overflow-toggle" @click.stop="toggleSuggestionMenu(s.id)" aria-label="More actions">¬∑¬∑¬∑</button>
                      <button class="remove-btn btn-sm" @click="removeSuggestion(s)"
                              x-show="activePlan?.plan?.status === 'open' && s.suggested_by === username"
                              :aria-label="'Remove ' + s.place">‚úï</button>
                      <div class="overflow-menu" x-show="suggestionMenuOpen === s.id" @click.outside="closeSuggestionMenu()" x-collapse>
                        <button class="downvote-btn" :class="{ downvoted: s.user_downvoted }"
                                @click="toggleDownvote(s); closeSuggestionMenu()"
                                :aria-label="s.user_downvoted ? 'Remove downvote from ' + s.place : 'Downvote ' + s.place"
                                x-show="activePlan?.plan?.status === 'open' && (s.veto_count || 0) === 0">üëé <span x-text="s.user_downvoted ? 'Remove Downvote' : 'Downvote'"></span></button>
                        <button class="veto-btn" :class="{ vetoed: s.user_vetoed }"
                                @click="toggleVeto(s); closeSuggestionMenu()"
                                :disabled="!s.user_vetoed && (activePlan?.vetoesRemaining || 0) <= 0"
                                :aria-label="s.user_vetoed ? 'Remove veto from ' + s.place : 'Veto ' + s.place"
                                :title="s.user_vetoed ? 'Remove veto' : (activePlan?.vetoesRemaining || 0) > 0 ? 'Veto (eliminates from pick)' : 'No vetoes remaining'"
                                x-show="activePlan?.plan?.status === 'open' && (activePlan?.plan?.veto_limit ?? 1) > 0"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/></svg> <span x-text="s.user_vetoed ? 'Remove Veto' : 'Veto (' + (activePlan?.vetoesRemaining || 0) + ' left)'"></span></button>
                        <span class="overflow-divider"></span>
                        <a class="reviews-link" x-show="s.place_id" :href="googleReviewsUrl(s.place, s.place_id)"
                           target="_blank" rel="noopener" aria-label="View Google reviews">‚òÖ Reviews</a>
                        <button class="map-btn" @click="openMap(s.place)" aria-label="View on map"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z"/></svg> Map</button>
                        <span class="overflow-divider"></span>
                        <button class="save-list-btn save-fav-btn" @click="addSuggestionToList(s, 'favorite')"
                                :disabled="suggestionInList(s.place) != null"
                                :title="suggestionInList(s.place) ? 'Already in your ' + suggestionInList(s.place).replace('_', ' ') : 'Add to Favorites'">&#x2605; Fav</button>
                        <button class="save-list-btn save-like-btn" @click="addSuggestionToList(s, 'like')"
                                :disabled="suggestionInList(s.place) != null"
                                :title="suggestionInList(s.place) ? 'Already in your ' + suggestionInList(s.place).replace('_', ' ') : 'Add to Likes'">&#x1F44D; Like</button>
                        <button class="save-list-btn save-dislike-btn" @click="addSuggestionToList(s, 'dislike')"
                                :disabled="suggestionInList(s.place) != null"
                                :title="suggestionInList(s.place) ? 'Already in your ' + suggestionInList(s.place).replace('_', ' ') : 'Add to Dislikes'">&#x1F44E; Dislike</button>
                        <button class="save-list-btn save-wtt-btn" @click="addSuggestionToList(s, 'want_to_try')"
                                :disabled="suggestionInList(s.place) != null"
                                :title="suggestionInList(s.place) ? 'Already in your ' + suggestionInList(s.place).replace('_', ' ') : 'Add to Want to Try'">&#x2B50; Try</button>
                      </div>
                    </div>
                    <div class="voters-list" x-show="s._showVoters && ((s.voters?.length > 0) || (s.downvoters?.length > 0) || (s.vetoers?.length > 0))" x-collapse>
                      <template x-for="voter in s.voters || []" :key="'up-' + voter">
                        <span class="voter-chip">
                          <span class="avatar avatar-xxs avatar-inline" :class="{ 'avatar-pic': memberLookup(voter)?.profile_pic }" :style="avatarStyle(memberLookup(voter) || { username: voter })" x-text="memberLookup(voter)?.profile_pic ? '' : getInitials(memberLookup(voter)?.display_name || voter)"></span>
                          <span x-text="memberLookup(voter)?.display_name || voter"></span>
                          <span class="vote-type-indicator vote-type-up">+</span>
                        </span>
                      </template>
                      <template x-for="voter in s.downvoters || []" :key="'down-' + voter">
                        <span class="voter-chip voter-chip-down">
                          <span class="avatar avatar-xxs avatar-inline" :class="{ 'avatar-pic': memberLookup(voter)?.profile_pic }" :style="avatarStyle(memberLookup(voter) || { username: voter })" x-text="memberLookup(voter)?.profile_pic ? '' : getInitials(memberLookup(voter)?.display_name || voter)"></span>
                          <span x-text="memberLookup(voter)?.display_name || voter"></span>
                          <span class="vote-type-indicator vote-type-down">-</span>
                        </span>
                      </template>
                      <template x-for="vetoer in s.vetoers || []" :key="'veto-' + vetoer">
                        <span class="voter-chip voter-chip-veto">
                          <span class="avatar avatar-xxs avatar-inline" :class="{ 'avatar-pic': memberLookup(vetoer)?.profile_pic }" :style="avatarStyle(memberLookup(vetoer) || { username: vetoer })" x-text="memberLookup(vetoer)?.profile_pic ? '' : getInitials(memberLookup(vetoer)?.display_name || vetoer)"></span>
                          <span x-text="memberLookup(vetoer)?.display_name || vetoer"></span>
                          <span class="vote-type-indicator vote-type-veto"><svg class="icon icon-xxs" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 13.59L15.59 17 12 13.41 8.41 17 7 15.59 10.59 12 7 8.41 8.41 7 12 10.59 15.59 7 17 8.41 13.41 12 17 15.59z"/></svg></span>
                        </span>
                      </template>
                    </div>
                  </li>
                </template>
              </ul>
              <div x-show="!activePlan?.suggestions?.length" class="empty-state">
                <span class="empty-state-icon">&#x1F4DD;</span>
                <p>No suggestions yet.</p>
                <p class="empty-state-hint">Search for a restaurant or quick-suggest from your likes.</p>
              </div>

              <!-- Pick Buttons -->
              <div class="buttons pick-buttons" x-show="activePlan?.suggestions?.length > 0 && activePlan?.plan?.status === 'open'">
                <button @click="randomPick()" :disabled="picking" aria-label="Random pick weighted by votes">üé≤ Random Pick</button>
                <button @click="closestPick()" :disabled="picking" aria-label="Pick the closest restaurant"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5a2.5 2.5 0 010-5 2.5 2.5 0 010 5z"/></svg> Closest</button>
              </div>

              <!-- Spin Wheel Modal (rendered outside flow, positioned fixed) -->
              <div class="spin-wheel-modal" x-show="spinningWheel"
                   x-transition:enter="transition ease-out duration-300"
                   x-transition:enter-start="opacity-0"
                   x-transition:enter-end="opacity-100"
                   x-transition:leave="transition ease-in duration-200"
                   x-transition:leave-start="opacity-100"
                   x-transition:leave-end="opacity-0">
                <div class="spin-wheel-container">
                  <canvas id="spin-wheel-canvas"></canvas>
                </div>
              </div>

              <!-- Winner Display -->
              <div class="winner-display" x-show="winner && !spinningWheel" x-transition>
                <h3 x-text="winner ? displayName(winner) : ''" id="winner-text"></h3>
                <p x-show="winner?.distance != null" x-text="winnerDistanceText"></p>
                <a :href="winnerMapUrl" target="_blank" rel="noopener"
                   x-text="winner?.distance != null ? 'Get Directions' : 'View on Google Maps'"></a>
                <button class="share-btn" @click="shareWinner()" aria-label="Share result"><svg class="icon" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"/></svg> Share</button>
                <!-- Reservation Links -->
                <div class="reservation-links" x-show="winner">
                  <span class="reservation-label">Book a table:</span>
                  <div class="reservation-buttons">
                    <a class="reservation-btn opentable" :href="openTableUrl(winner?.place)" target="_blank" rel="noopener">OpenTable</a>
                    <a class="reservation-btn yelp" :href="yelpUrl(winner?.place)" target="_blank" rel="noopener">Yelp</a>
                    <a class="reservation-btn google" :href="reservationSearchUrl(winner?.place)" target="_blank" rel="noopener">Reservations</a>
                  </div>
                </div>
                <!-- Plan Recap -->
                <div class="plan-recap" x-show="planRecap">
                  <div class="recap-stat">
                    <span class="recap-label">Suggestions</span>
                    <span x-text="planRecap?.totalSuggestions"></span>
                  </div>
                  <div class="recap-stat">
                    <span class="recap-label">Votes</span>
                    <span x-text="'+' + planRecap?.totalVotes + ' / -' + (planRecap?.totalDownvotes || 0)"></span>
                  </div>
                  <div class="recap-stat">
                    <span class="recap-label">Suggested by</span>
                    <span x-text="planRecap?.suggestedBy"></span>
                  </div>
                  <div x-show="planRecap?.topPlaces?.length > 1">
                    <span class="recap-label">Top Picks</span>
                    <template x-for="tp in planRecap?.topPlaces || []" :key="tp.place">
                      <span class="recap-place" x-text="tp.place + ' (+' + tp.vote_count + '/-' + (tp.downvote_count || 0) + ')'"></span>
                    </template>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê ACCOUNT TAB ‚ïê‚ïê‚ïê -->
        <section x-show="activeTab === 'account'" x-transition:enter="tab-transition-enter" x-transition:enter-start="tab-transition-enter-from" x-transition:enter-end="tab-transition-enter-to">
          <h3>Account Settings</h3>

          <!-- Account Sub-tabs -->
          <div class="admin-sub-tabs">
            <button class="admin-sub-tab" :class="{ active: accountTab === 'profile' }" @click="accountTab = 'profile'">Profile</button>
            <button class="admin-sub-tab" :class="{ active: accountTab === 'stats' }" @click="accountTab = 'stats'; loadStats()">Stats</button>
            <button class="admin-sub-tab" :class="{ active: accountTab === 'badges' }" @click="accountTab = 'badges'; loadBadges()">Badges</button>
            <button class="admin-sub-tab" :class="{ active: accountTab === 'security' }" @click="accountTab = 'security'">Security</button>
            <button class="admin-sub-tab" :class="{ active: accountTab === 'notifications' }" @click="accountTab = 'notifications'">Notifications</button>
            <button class="admin-sub-tab" :class="{ active: accountTab === 'danger' }" @click="accountTab = 'danger'">Danger Zone</button>
          </div>

          <!-- Profile Sub-tab -->
          <div x-show="accountTab === 'profile'" x-effect="if (accountTab === 'profile') { profileForm.displayName = profileName; profileForm.profilePicPreview = null; profileForm.profilePicData = undefined; }">
            <div class="profile-edit-section">
              <h4>Profile Picture</h4>
              <div class="profile-pic-area">
                <div class="profile-pic-preview">
                  <template x-if="profileForm.profilePicPreview || profilePic">
                    <img class="avatar avatar-lg avatar-pic" :src="profileForm.profilePicPreview || profilePic" alt="Profile picture" />
                  </template>
                  <template x-if="!profileForm.profilePicPreview && !profilePic">
                    <span class="avatar avatar-lg" :style="{ background: hashColor(profileForm.displayName || profileName || username) }"
                          x-text="getInitials(profileForm.displayName || profileName || username)"></span>
                  </template>
                </div>
                <div class="profile-pic-actions">
                  <label class="suggest-btn profile-upload-btn">
                    Upload Photo
                    <input type="file" accept="image/*" @change="handleProfilePicUpload($event)" hidden />
                  </label>
                  <button class="back-btn" x-show="profilePic || profileForm.profilePicPreview"
                          @click="removeProfilePic()">Remove</button>
                </div>
              </div>

              <h4>Display Name</h4>
              <p style="font-size: 0.9rem; color: var(--text-secondary);">
                Shown as your primary name. Your username (<strong>@<span x-text="username"></span></strong>) is still used for login and @mentions.
              </p>
              <div class="inline-input">
                <input type="text" x-model="profileForm.displayName" placeholder="Display name (optional)"
                       maxlength="50" @keydown.enter="updateProfile()" aria-label="Display name" />
              </div>
              <button class="suggest-btn" style="margin-top: 0.5rem;" @click="updateProfile()" :disabled="profileSaving">
                <span x-text="profileSaving ? 'Saving...' : 'Save Profile'"></span>
              </button>
            </div>

            <h4>Update Email</h4>
            <p style="font-size: 0.9rem; color: var(--text-secondary);">Current: <span x-text="email || 'Not set'"></span></p>
            <div class="inline-input">
              <input type="email" x-model="accountForm.newEmail" placeholder="New email address"
                     @keydown.enter="updateEmail()" aria-label="New email address" />
              <button @click="updateEmail()">Update</button>
            </div>

            <h4 style="margin-top: 1.5rem;">Accent Color</h4>
            <div class="accent-picker">
              <template x-for="(palette, key) in accentPalettes" :key="key">
                <button class="accent-swatch"
                        :class="{ active: accentColor === key }"
                        :style="{ '--swatch-color': palette.light.accent, '--swatch-dark': palette.dark.accent }"
                        @mouseenter="applyAccentColor(key, true)"
                        @mouseleave="resetAccentPreview()"
                        @click="applyAccentColor(key)"
                        :aria-label="palette.name + ' accent color'"
                        :title="palette.name">
                  <span class="accent-swatch-color"></span>
                  <span class="accent-swatch-label" x-text="palette.name"></span>
                </button>
              </template>
            </div>
          </div>

          <!-- Stats Sub-tab -->
          <div x-show="accountTab === 'stats'">
            <div x-show="statsLoading" class="loading-spinner">Loading stats...</div>
            <div x-show="userStats && !statsLoading">
              <!-- Stat Cards Grid -->
              <div class="stats-grid">
                <div class="stat-card">
                  <span class="stat-value" x-text="userStats?.restaurantsVisited || 0"></span>
                  <span class="stat-label">Restaurants Visited</span>
                </div>
                <div class="stat-card">
                  <span class="stat-value" x-text="userStats?.plansJoined || 0"></span>
                  <span class="stat-label">Plans Joined</span>
                </div>
                <div class="stat-card">
                  <span class="stat-value" x-text="(userStats?.winRate || 0) + '%'"></span>
                  <span class="stat-label">Win Rate</span>
                </div>
                <div class="stat-card">
                  <span class="stat-value" x-text="userStats?.totalSuggested || 0"></span>
                  <span class="stat-label">Places Suggested</span>
                </div>
              </div>

              <!-- Voting Patterns -->
              <h4>Voting Patterns</h4>
              <div class="stat-bar-container">
                <div class="stat-bar">
                  <div class="stat-bar-fill stat-bar-up" :style="{ width: ((userStats?.upvotes || 0) / Math.max((userStats?.upvotes || 0) + (userStats?.downvotes || 0), 1) * 100) + '%' }"></div>
                </div>
                <div class="stat-bar-legend">
                  <span class="stat-bar-legend-item up">Upvotes: <strong x-text="userStats?.upvotes || 0"></strong></span>
                  <span class="stat-bar-legend-item down">Downvotes: <strong x-text="userStats?.downvotes || 0"></strong></span>
                  <span class="stat-bar-legend-item veto">Vetoes: <strong x-text="userStats?.vetoes || 0"></strong></span>
                </div>
              </div>

              <!-- Favorite Cuisines -->
              <h4 x-show="userStats?.topCuisines?.length > 0">Favorite Cuisines</h4>
              <div class="stat-h-bars" x-show="userStats?.topCuisines?.length > 0">
                <template x-for="c in (userStats?.topCuisines || [])" :key="c.type">
                  <div class="stat-h-bar-row">
                    <span class="stat-h-bar-label" x-text="c.type"></span>
                    <div class="stat-h-bar">
                      <div class="stat-h-bar-fill" :style="{ width: (c.count / (userStats.topCuisines[0]?.count || 1) * 100) + '%' }"></div>
                    </div>
                    <span class="stat-h-bar-count" x-text="c.count"></span>
                  </div>
                </template>
              </div>

              <!-- Top Companions -->
              <h4 x-show="userStats?.topCompanions?.length > 0">Top Dining Companions</h4>
              <div class="stat-companions" x-show="userStats?.topCompanions?.length > 0">
                <template x-for="comp in (userStats?.topCompanions || [])" :key="comp.username">
                  <div class="stat-companion">
                    <span class="avatar avatar-sm" :class="{ 'avatar-pic': comp.profile_pic }" :style="avatarStyle(comp)" x-text="comp.profile_pic ? '' : getInitials(comp.display_name || comp.username)"></span>
                    <span x-text="comp.display_name || comp.username"></span>
                    <span class="stat-companion-count" x-text="comp.count + ' plans'"></span>
                  </div>
                </template>
              </div>

              <!-- Places Pie Chart -->
              <h4>Your Places</h4>
              <div class="stat-pie-container">
                <div class="stat-pie" :style="{
                  background: 'conic-gradient(var(--success) 0% ' + (userStats?.likesCount / Math.max((userStats?.likesCount || 0) + (userStats?.dislikesCount || 0) + (userStats?.wantToTryCount || 0), 1) * 100) + '%, var(--danger) ' + (userStats?.likesCount / Math.max((userStats?.likesCount || 0) + (userStats?.dislikesCount || 0) + (userStats?.wantToTryCount || 0), 1) * 100) + '% ' + ((userStats?.likesCount + userStats?.dislikesCount) / Math.max((userStats?.likesCount || 0) + (userStats?.dislikesCount || 0) + (userStats?.wantToTryCount || 0), 1) * 100) + '%, var(--warning) ' + ((userStats?.likesCount + userStats?.dislikesCount) / Math.max((userStats?.likesCount || 0) + (userStats?.dislikesCount || 0) + (userStats?.wantToTryCount || 0), 1) * 100) + '% 100%)'
                }"></div>
                <div class="stat-pie-legend">
                  <span class="stat-pie-legend-item"><span class="stat-pie-dot" style="background: var(--success);"></span> Likes: <strong x-text="userStats?.likesCount || 0"></strong></span>
                  <span class="stat-pie-legend-item"><span class="stat-pie-dot" style="background: var(--danger);"></span> Dislikes: <strong x-text="userStats?.dislikesCount || 0"></strong></span>
                  <span class="stat-pie-legend-item"><span class="stat-pie-dot" style="background: var(--warning);"></span> Want to Try: <strong x-text="userStats?.wantToTryCount || 0"></strong></span>
                </div>
              </div>

              <!-- Adventure Score -->
              <h4>Adventure Score</h4>
              <div class="adventure-score">
                <div class="adventure-gauge">
                  <svg viewBox="0 0 100 50" class="adventure-svg">
                    <path d="M 10 45 A 40 40 0 0 1 90 45" fill="none" stroke="var(--border)" stroke-width="8" stroke-linecap="round" />
                    <path d="M 10 45 A 40 40 0 0 1 90 45" fill="none" stroke="var(--accent)" stroke-width="8" stroke-linecap="round"
                          :stroke-dasharray="(userStats?.adventureScore || 0) * 1.26 + ' 126'" />
                  </svg>
                  <span class="adventure-value" x-text="(userStats?.adventureScore || 0) + '%'"></span>
                </div>
                <span class="adventure-label">Cuisine variety explored</span>
              </div>

              <!-- Monthly Activity -->
              <h4 x-show="userStats?.monthlyActivity?.length > 0">Monthly Activity</h4>
              <div class="monthly-chart" x-show="userStats?.monthlyActivity?.length > 0">
                <template x-for="m in (userStats?.monthlyActivity || [])" :key="m.month">
                  <div class="monthly-bar-col">
                    <div class="monthly-bar" :style="{ height: Math.max(m.plans_count * 15, 4) + 'px' }"
                         :title="m.plans_count + ' plans'"></div>
                    <span class="monthly-label" x-text="m.month.split('-')[1]"></span>
                  </div>
                </template>
              </div>

              <!-- Average Group Size -->
              <div class="stat-extra" x-show="userStats?.avgGroupSize">
                <span class="stat-extra-label">Avg Group Size:</span>
                <strong x-text="userStats?.avgGroupSize"></strong>
              </div>
            </div>
          </div>

          <!-- Badges Sub-tab -->
          <div x-show="accountTab === 'badges'">
            <div x-show="badgesLoading" class="loading-spinner">Loading badges...</div>
            <div x-show="!badgesLoading && badges.length > 0">
              <h4 x-show="earnedBadges.length > 0">Earned Badges</h4>
              <div class="badge-grid" x-show="earnedBadges.length > 0">
                <template x-for="badge in earnedBadges" :key="badge.id">
                  <div class="badge-card badge-earned">
                    <span class="badge-icon" x-text="badge.icon"></span>
                    <span class="badge-name" x-text="badge.name"></span>
                    <span class="badge-desc" x-text="badge.desc"></span>
                    <div class="badge-progress-bar"><div class="badge-progress-fill" style="width: 100%;"></div></div>
                    <span class="badge-complete">Complete!</span>
                  </div>
                </template>
              </div>
              <h4 x-show="unearnedBadges.length > 0">In Progress</h4>
              <div class="badge-grid" x-show="unearnedBadges.length > 0">
                <template x-for="badge in unearnedBadges" :key="badge.id">
                  <div class="badge-card badge-locked">
                    <span class="badge-icon" x-text="badge.icon"></span>
                    <span class="badge-name" x-text="badge.name"></span>
                    <span class="badge-desc" x-text="badge.desc"></span>
                    <div class="badge-progress-bar"><div class="badge-progress-fill" :style="{ width: Math.min(badge.current / badge.target * 100, 100) + '%' }"></div></div>
                    <span class="badge-progress-text" x-text="badge.current + ' / ' + badge.target"></span>
                  </div>
                </template>
              </div>
            </div>
          </div>

          <!-- Security Sub-tab -->
          <div x-show="accountTab === 'security'">
            <h4>Change Password</h4>
            <input type="password" x-model="accountForm.currentPassword" placeholder="Current password" aria-label="Current password" />
            <input type="password" x-model="accountForm.newPassword" placeholder="New password (min 6 chars)" aria-label="New password" />
            <input type="password" x-model="accountForm.confirmNewPassword" placeholder="Confirm new password"
                   aria-label="Confirm new password" />
            <p class="auth-error" x-show="accountForm.newPassword && accountForm.confirmNewPassword && accountForm.newPassword !== accountForm.confirmNewPassword">
              Passwords do not match.
            </p>
            <button @click="changePassword()"
                    :disabled="!accountForm.currentPassword || !accountForm.newPassword || accountForm.newPassword !== accountForm.confirmNewPassword">Change Password</button>
          </div>

          <!-- Notifications Sub-tab -->
          <div x-show="accountTab === 'notifications'">
            <h4>Push Notifications</h4>
            <p x-show="!notificationsSupported" class="warning-text">Push notifications are not supported in this browser.</p>
            <div x-show="notificationsSupported">
              <button @click="notificationsEnabled ? disableNotifications() : enableNotifications()"
                      x-text="notificationsEnabled ? 'Disable Notifications' : 'Enable Notifications'"
                      :class="notificationsEnabled ? 'remove-btn' : 'suggest-btn'"></button>
              <p class="notification-hint" x-show="notificationsEnabled">You'll receive notifications for plan updates, friend requests, and more.</p>
            </div>
          </div>

          <!-- Danger Zone Sub-tab -->
          <div x-show="accountTab === 'danger'">
            <h4>Export Data</h4>
            <p class="warning-text">Download all your data as a JSON file.</p>
            <button class="account-btn" @click="exportData()">Export My Data</button>

            <h4 class="danger-zone" style="margin-top: 1.5rem;">Delete Account</h4>
            <p class="warning-text">This will permanently delete your account and all data.</p>
            <input type="password" x-model="accountForm.deletePassword" placeholder="Enter password to confirm" aria-label="Password to confirm deletion" />
            <button class="remove-btn" @click="deleteAccount()">Delete My Account</button>
          </div>
        </section>

        <!-- ‚ïê‚ïê‚ïê ADMIN TAB ‚ïê‚ïê‚ïê -->
        <section x-show="activeTab === 'admin' && isAdmin" x-transition:enter="tab-transition-enter" x-transition:enter-start="tab-transition-enter-from" x-transition:enter-end="tab-transition-enter-to"
                 x-init="$watch('activeTab', val => { if (val === 'admin') switchAdminTab(adminTab); })">
          <h3>Admin Panel</h3>

          <!-- Admin Sub-tabs -->
          <div class="admin-sub-tabs">
            <button class="admin-sub-tab" :class="{ active: adminTab === 'dashboard' }" @click="switchAdminTab('dashboard')">Dashboard</button>
            <button class="admin-sub-tab" :class="{ active: adminTab === 'users' }" @click="switchAdminTab('users')">Users</button>
            <button class="admin-sub-tab" :class="{ active: adminTab === 'smtp' }" @click="switchAdminTab('smtp')">SMTP</button>
            <button class="admin-sub-tab" :class="{ active: adminTab === 'vapid' }" @click="switchAdminTab('vapid')">VAPID</button>
            <button class="admin-sub-tab" :class="{ active: adminTab === 'settings' }" @click="switchAdminTab('settings')">Settings</button>
            <button class="admin-sub-tab" :class="{ active: adminTab === 'plans' }" @click="switchAdminTab('plans')">Plans</button>
          </div>

          <!-- Dashboard Sub-tab -->
          <div x-show="adminTab === 'dashboard'">
            <div x-show="!adminStats" class="empty-state">
              <p>Loading stats...</p>
            </div>
            <div x-show="adminStats" class="admin-stats-grid">
              <div class="admin-stat-card">
                <div class="admin-stat-value" x-text="adminStats?.users ?? '-'"></div>
                <div class="admin-stat-label">Users</div>
              </div>
              <div class="admin-stat-card">
                <div class="admin-stat-value" x-text="adminStats?.plans ?? '-'"></div>
                <div class="admin-stat-label">Plans</div>
              </div>
              <div class="admin-stat-card">
                <div class="admin-stat-value" x-text="adminStats?.active_plans ?? '-'"></div>
                <div class="admin-stat-label">Active Plans</div>
              </div>
              <div class="admin-stat-card">
                <div class="admin-stat-value" x-text="adminStats?.places ?? '-'"></div>
                <div class="admin-stat-label">Places</div>
              </div>
            </div>
            <div x-show="adminStats" style="margin-top: 1rem;">
              <div class="admin-form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
                <span>SMTP:</span>
                <span class="admin-status-indicator" :class="adminStats?.smtp_configured ? 'configured' : 'not-configured'"></span>
                <span x-text="adminStats?.smtp_configured ? 'Configured' : 'Not configured'"
                      :style="{ color: adminStats?.smtp_configured ? 'var(--success)' : 'var(--danger)' }"></span>
              </div>
              <div class="admin-form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
                <span>VAPID:</span>
                <span class="admin-status-indicator" :class="adminStats?.vapid_source !== 'none' ? 'configured' : 'not-configured'"></span>
                <span x-text="adminStats?.vapid_source ? ('Source: ' + adminStats.vapid_source) : 'Not configured'"
                      :style="{ color: adminStats?.vapid_source && adminStats.vapid_source !== 'none' ? 'var(--success)' : 'var(--danger)' }"></span>
              </div>
              <div style="margin-top: 1rem;">
                <button class="btn btn-primary" @click="adminBackup()" :disabled="adminBackingUp" aria-label="Create database backup">
                  <span x-text="adminBackingUp ? 'Backing up...' : 'Backup Database'"></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Users Sub-tab -->
          <div x-show="adminTab === 'users'">
            <div x-show="adminUsers.length === 0" class="empty-state">
              <p>No users found.</p>
            </div>
            <div class="admin-user-list" x-show="adminUsers.length > 0">
              <template x-for="u in adminUsers" :key="u.id">
                <div class="admin-user-row">
                  <div class="admin-user-info">
                    <span class="avatar avatar-sm" :class="{ 'avatar-pic': u.profile_pic }" :style="avatarStyle(u)" x-text="u.profile_pic ? '' : getInitials(u.display_name || u.username)"></span>
                    <div class="admin-user-details">
                      <strong x-text="u.display_name || u.username"></strong>
                      <span class="username-secondary" x-show="u.display_name" x-text="'@' + u.username"></span>
                      <span class="admin-user-email" x-text="u.email || 'No email'"></span>
                      <span class="admin-user-meta">
                        <span class="type-badge" x-show="u.is_admin">Admin</span>
                        <span class="admin-user-date" x-text="'Joined ' + formatDate(u.created_at)"></span>
                      </span>
                    </div>
                  </div>
                  <div class="admin-user-actions" x-show="u.id !== userId && adminEditUser !== u.id">
                    <button class="admin-btn" @click="adminStartEdit(u)">Edit</button>
                    <button class="admin-btn warning" @click="adminResetPassword(u.id)"
                            x-text="adminResetPwUser === u.id ? 'Confirm Reset' : 'Reset PW'"></button>
                    <button class="admin-btn" x-show="adminResetPwUser === u.id"
                            @click="adminCancelResetPassword()">Cancel</button>
                    <button class="admin-btn success" @click="adminToggleAdmin(u.id)"
                            x-text="u.is_admin ? 'Remove Admin' : 'Make Admin'"></button>
                    <button class="admin-btn danger" @click="adminDeleteUser(u.id)">Delete</button>
                  </div>
                  <div class="admin-user-actions" x-show="u.id === userId && adminEditUser !== u.id">
                    <button class="admin-btn" @click="adminStartEdit(u)">Edit</button>
                    <span class="type-badge" style="background: var(--accent); color: white;">You</span>
                  </div>
                  <!-- Inline edit form -->
                  <div class="admin-edit-inline" x-show="adminEditUser === u.id">
                    <div class="admin-form-group">
                      <label>Username</label>
                      <input type="text" x-model="adminEditForm.username" placeholder="Username"
                             @keydown.enter="adminSaveEdit(u.id)" />
                    </div>
                    <div class="admin-form-group">
                      <label>Email</label>
                      <input type="email" x-model="adminEditForm.email" placeholder="Email address"
                             @keydown.enter="adminSaveEdit(u.id)" />
                    </div>
                    <div class="admin-user-actions">
                      <button class="admin-btn primary" @click="adminSaveEdit(u.id)">Save</button>
                      <button class="admin-btn" @click="adminCancelEdit()">Cancel</button>
                    </div>
                  </div>
                  <!-- Inline password reset input -->
                  <div class="admin-reset-pw-inline" x-show="adminResetPwUser === u.id">
                    <input type="password" x-model="adminResetPwValue" placeholder="New password (min 6 chars)"
                           @keydown.enter="adminResetPassword(u.id)" aria-label="New password for user" />
                  </div>
                </div>
              </template>
            </div>
          </div>

          <!-- SMTP Sub-tab -->
          <div x-show="adminTab === 'smtp'">
            <div class="admin-form-group">
              <label for="admin-smtp-host">SMTP Host</label>
              <input id="admin-smtp-host" x-model="adminSmtp.host" placeholder="smtp.example.com" />
            </div>
            <div class="admin-form-group">
              <label for="admin-smtp-port">Port</label>
              <input id="admin-smtp-port" type="number" x-model.number="adminSmtp.port" placeholder="587" />
            </div>
            <div class="admin-form-group">
              <label for="admin-smtp-user">Username</label>
              <input id="admin-smtp-user" x-model="adminSmtp.user" placeholder="user@example.com" />
            </div>
            <div class="admin-form-group">
              <label for="admin-smtp-password">Password</label>
              <input id="admin-smtp-password" type="password" x-model="adminSmtp.password"
                     placeholder="Leave blank to keep existing" />
            </div>
            <div class="admin-form-group">
              <label for="admin-smtp-from">From Address</label>
              <input id="admin-smtp-from" x-model="adminSmtp.from" placeholder="noreply@example.com" />
            </div>
            <div class="admin-form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="admin-smtp-secure" x-model="adminSmtp.secure" style="width: auto;" />
              <label for="admin-smtp-secure" style="margin: 0;">Use TLS/SSL</label>
            </div>
            <div style="margin-top: 1rem;">
              <button class="admin-btn primary" @click="saveAdminSmtp()">Save SMTP Settings</button>
            </div>

            <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-light);">
              <h4>Send Test Email</h4>
              <div class="inline-input">
                <input type="email" x-model="adminTestEmail" placeholder="test@example.com"
                       @keydown.enter="testSmtp()" aria-label="Test email address" />
                <button class="admin-btn primary" @click="testSmtp()">Send Test</button>
              </div>
            </div>
          </div>

          <!-- VAPID Sub-tab -->
          <div x-show="adminTab === 'vapid'">
            <div class="admin-form-group">
              <label>Public Key</label>
              <div class="admin-key-display" x-text="adminVapid.publicKey || 'No VAPID key configured'"></div>
            </div>
            <div class="admin-form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
              <span>Source:</span>
              <span class="type-badge" x-text="adminVapid.source || 'none'"></span>
            </div>
            <div style="margin-top: 1rem;">
              <button class="admin-btn warning" @click="generateVapid()">Generate New VAPID Keys</button>
            </div>
            <p class="warning-text" style="margin-top: 0.5rem;">
              Generating new keys will break all existing push notification subscriptions.
              Users will need to re-enable notifications.
            </p>
          </div>

          <!-- Settings Sub-tab -->
          <div x-show="adminTab === 'settings'">
            <div class="admin-form-group">
              <label for="admin-google-key">Google API Key</label>
              <div class="admin-key-display" x-show="adminGoogleKey" x-text="adminGoogleKey"></div>
              <input id="admin-google-key" x-model="adminGoogleKey" placeholder="Enter Google API key" />
              <button class="admin-btn primary" @click="saveAdminGoogleKey()" style="margin-top: 0.3rem;">Save API Key</button>
              <button class="admin-btn" @click="adminRepullPlaces()" :disabled="adminRepulling || !adminGoogleKey" style="margin-top: 0.3rem;">
                <span x-show="!adminRepulling">Refresh All Place Data</span>
                <span x-show="adminRepulling">Refreshing...</span>
              </button>
            </div>

            <div class="admin-form-group">
              <label for="admin-giphy-key">Giphy API Key</label>
              <div class="admin-key-display" x-show="adminGiphyKey" x-text="adminGiphyKey"></div>
              <input id="admin-giphy-key" x-model="adminGiphyKey" placeholder="Enter Giphy API key" />
              <button class="admin-btn primary" @click="saveAdminGiphyKey()" style="margin-top: 0.3rem;">Save API Key</button>
            </div>

            <div class="admin-form-group">
              <label for="admin-jwt-expiry">JWT Token Expiry</label>
              <select id="admin-jwt-expiry" class="filter-select" x-model="adminSettings.jwt_expiry">
                <option value="1h">1 hour</option>
                <option value="6h">6 hours</option>
                <option value="12h">12 hours</option>
                <option value="24h">24 hours</option>
                <option value="7d">7 days</option>
              </select>
            </div>

            <div class="admin-form-group" style="flex-direction: row; align-items: center; gap: 0.5rem;">
              <input type="checkbox" id="admin-cookie-secure" style="width: auto;"
                     :checked="adminSettings.cookie_secure === 'true'"
                     @change="adminSettings.cookie_secure = $event.target.checked ? 'true' : 'false'" />
              <label for="admin-cookie-secure" style="margin: 0;">Cookie Secure flag (requires HTTPS)</label>
            </div>

            <div style="margin-top: 1rem;">
              <button class="admin-btn primary" @click="saveAdminSettings()">Save Settings</button>
            </div>
          </div>

          <!-- Plans Sub-tab -->
          <div x-show="adminTab === 'plans'">
            <div x-show="adminPlans.length === 0" class="empty-state">
              <p>No plans found.</p>
            </div>
            <div class="admin-plans-list">
              <template x-for="plan in adminPlans" :key="plan.id">
                <div class="admin-plan-card">
                  <div class="admin-plan-header">
                    <strong x-text="plan.name"></strong>
                    <span class="admin-plan-status" :class="plan.status" x-text="plan.status"></span>
                  </div>
                  <div class="admin-plan-details">
                    <span>Code: <strong x-text="plan.code"></strong></span>
                    <span>Creator: <span x-text="plan.creator_name || 'Unknown'"></span></span>
                    <span>Members: <span x-text="plan.member_count"></span></span>
                    <span>Suggestions: <span x-text="plan.suggestion_count"></span></span>
                    <span x-show="plan.winner_place">Winner: <span x-text="plan.winner_place"></span></span>
                    <span>Created: <span x-text="new Date(plan.created_at).toLocaleDateString()"></span></span>
                  </div>
                  <div class="admin-plan-actions">
                    <button class="admin-btn success" x-show="plan.status === 'open'" @click="adminClosePlan(plan.id)">Close</button>
                    <button class="admin-btn danger" @click="adminDeletePlan(plan.id)">Delete</button>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </section>

      </div>
    </main>

    <!-- Chat Drawer Backdrop -->
    <div class="chat-drawer-backdrop" x-show="chatDrawerOpen" x-transition.opacity.duration.200ms
         @click="toggleChatDrawer()"></div>

    <!-- Chat Drawer -->
    <div class="chat-drawer" :class="{ open: chatDrawerOpen }">
      <div class="chat-drawer-header">
        <h3 x-text="activePlan?.plan?.name || 'Chat'"></h3>
        <button class="chat-drawer-close" @click="toggleChatDrawer()" aria-label="Close chat">&times;</button>
      </div>

      <div id="chat-messages" class="chat-messages">
        <div x-show="chatMessages.length === 0" class="chat-empty">
          No messages yet. Start the conversation!
        </div>
        <template x-for="(msg, msgIdx) in chatMessages" :key="msg.id">
          <div class="chat-message" :class="{ own: msg.user_id === userId }">
            <span class="chat-avatar avatar avatar-xs" :class="{ 'avatar-pic': msg.profile_pic }" :style="avatarStyle(msg)" x-text="msg.profile_pic ? '' : getInitials(msg.display_name || msg.username)"></span>
            <div class="chat-bubble-wrapper">
              <div class="chat-bubble" :class="{ 'chat-bubble-gif': msg.message_type === 'gif' }">
                <div class="chat-bubble-name" x-show="msg.user_id !== userId" x-text="msg.display_name || msg.username"></div>
                <template x-if="editingMessageId === msg.id">
                  <div class="chat-edit-inline">
                    <input type="text" x-model="editingMessageText" @keydown.enter="saveMessageEdit()" @keydown.escape="cancelEditMessage()" class="chat-edit-input" />
                    <div class="chat-edit-actions">
                      <button class="chat-edit-save" @click="saveMessageEdit()" aria-label="Save edit">Save</button>
                      <button class="chat-edit-cancel" @click="cancelEditMessage()" aria-label="Cancel edit">Cancel</button>
                    </div>
                  </div>
                </template>
                <template x-if="editingMessageId !== msg.id">
                  <div>
                    <div x-show="msg.message_type !== 'gif'" x-html="formatMessageWithMentions(msg.message)"></div>
                    <img x-show="msg.message_type === 'gif'" :src="msg.message" alt="GIF" class="chat-gif" referrerpolicy="no-referrer" />
                    <div class="chat-bubble-time">
                      <span x-text="formatChatTime(msg.created_at)"></span>
                      <span x-show="msg.edited_at" class="chat-edited">(edited)</span>
                    </div>
                  </div>
                </template>
              </div>
              <div class="chat-msg-actions" x-show="msg.user_id === userId || isAdmin">
                <button class="react-trigger" x-show="msg.user_id === userId && msg.message_type !== 'gif'" @click="editChatMessage(msg)" title="Edit" aria-label="Edit message">&#9998;</button>
                <button class="react-trigger" @click="deleteChatMessage(msg.id)" title="Delete" aria-label="Delete message">&times;</button>
              </div>
              <div class="chat-reactions" x-show="msg.reactions && msg.reactions.length > 0">
                <template x-for="group in groupedReactions(msg.reactions)" :key="group.emoji">
                  <button class="reaction-chip" :class="{ 'reaction-mine': group.userReacted }"
                          @click="toggleReaction(msg.id, group.emoji)"
                          :title="group.users.join(', ')">
                    <span x-text="group.emoji"></span>
                    <span class="reaction-count" x-text="group.count" x-show="group.count > 1"></span>
                  </button>
                </template>
              </div>
              <button class="react-trigger" @click.stop="openReactionPicker(msg.id)" title="React" aria-label="Add reaction">+</button>
              <div class="reaction-picker" x-show="reactionPickerMessageId === msg.id"
                   @click.outside="reactionPickerMessageId = null">
                <template x-for="e in ['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üéâ','üçï','üî•']" :key="e">
                  <button class="reaction-picker-btn" @click="toggleReaction(msg.id, e)" x-text="e"></button>
                </template>
              </div>
            </div>
            <div class="chat-seen-by" x-show="isLastReadForSomeone(msg.id, msgIdx)" x-text="seenBy(msg.id)"></div>
          </div>
        </template>
      </div>

      <!-- Emoji Picker Panel -->
      <div class="emoji-picker-panel" x-show="emojiPickerVisible"
           @click.outside="emojiPickerVisible = false" x-transition>
        <template x-for="(emojis, category) in emojiCategories()" :key="category">
          <div>
            <div class="emoji-category-label" x-text="category"></div>
            <div class="emoji-grid">
              <template x-for="e in emojis" :key="e">
                <button class="emoji-btn" @click="insertEmoji(e)" x-text="e"></button>
              </template>
            </div>
          </div>
        </template>
      </div>

      <!-- GIF Search Panel -->
      <div class="gif-search-panel" x-show="gifSearchVisible"
           @click.outside="gifSearchVisible = false" x-transition>
        <input type="text" class="gif-search-input" x-model="gifSearchQuery"
               @input.debounce.400ms="searchGifs()" placeholder="Search GIPHY..."
               aria-label="Search GIFs" />
        <div x-show="gifError" class="chat-empty" x-text="gifError" style="color: var(--danger)"></div>
        <div class="gif-grid" x-show="!gifLoading && !gifError">
          <template x-for="gif in gifResults" :key="gif.id">
            <img :src="gif.preview" @click="gifPreview = gif.url" alt="GIF"
                 class="gif-thumb" referrerpolicy="no-referrer" />
          </template>
          <div x-show="gifResults.length === 0 && gifSearchQuery" class="chat-empty">No GIFs found</div>
        </div>
        <div x-show="gifLoading" class="chat-empty">Loading...</div>
        <div class="giphy-attribution">Powered by GIPHY</div>
        <!-- GIF Preview -->
        <div class="gif-preview-overlay" x-show="gifPreview" x-transition @click.self="gifPreview = null">
          <div class="gif-preview-card">
            <img :src="gifPreview" alt="GIF preview" class="gif-preview-img" referrerpolicy="no-referrer" />
            <div class="gif-preview-actions">
              <button class="back-btn" @click="gifPreview = null">Cancel</button>
              <button class="suggest-btn" @click="sendGif(gifPreview); gifPreview = null">Send</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Typing Indicator -->
      <div class="typing-indicator" x-show="typingUsers.length > 0" x-text="typingText" x-transition></div>

      <!-- Chat Input Row -->
      <div class="chat-input-wrapper">
        <div class="mention-dropdown" x-show="mentionDropdownVisible"
             @click.outside="mentionDropdownVisible = false" x-transition>
          <template x-for="(member, idx) in getMentionOptions()" :key="member.id">
            <button class="mention-option" :class="{ selected: idx === mentionSelectedIndex }"
                    @click="selectMention(idx)">
              <template x-if="member.isAll">
                <span class="mention-option-row">
                  <span class="mention-option-all">@all</span>
                  <span class="mention-option-desc">Mention everyone</span>
                </span>
              </template>
              <template x-if="!member.isAll">
                <span class="mention-option-row">
                  <span class="mention-option-avatar avatar-xs"
                        :class="{ 'avatar-pic': member.profile_pic }"
                        :style="avatarStyle(member)"
                        x-text="member.profile_pic ? '' : getInitials(member.display_name || member.username)"></span>
                  <span x-text="member.display_name || member.username"></span>
                  <span class="username-secondary" x-show="member.display_name" x-text="'@' + member.username"></span>
                </span>
              </template>
            </button>
          </template>
        </div>
        <button class="chat-action-btn" @click="toggleEmojiPicker()" title="Emoji"
                :class="{ active: emojiPickerVisible }" aria-label="Open emoji picker">üòÄ</button>
        <button class="chat-action-btn" @click="toggleGifSearch()" title="GIF"
                :class="{ active: gifSearchVisible }" aria-label="Search GIFs">GIF</button>
        <input x-ref="chatInputField" x-model="chatInput" placeholder="Type a message... (@mention)"
               maxlength="500" @input="onChatInput(); handleChatTyping()" @keydown="onMentionKeydown($event)"
               @keydown.enter="if (!mentionDropdownVisible) sendChatMessage()"
               aria-label="Chat message" />
        <button class="suggest-btn" @click="sendChatMessage()" :disabled="!chatInput.trim()" aria-label="Send"><svg class="icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
      </div>
    </div>

  </div>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js', { updateViaCache: 'none' });
    }
  </script>
</body>
</html>
